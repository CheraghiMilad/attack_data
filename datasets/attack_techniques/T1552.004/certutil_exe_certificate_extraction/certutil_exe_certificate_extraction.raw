<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Sysmon' Guid='{5770385F-C22A-43E0-BF4C-06F5698FFBD9}'/><EventID>1</EventID><Version>5</Version><Level>4</Level><Task>1</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime='2021-01-14T23:41:40.145335200Z'/><EventRecordID>19683891</EventRecordID><Correlation/><Execution ProcessID='2468' ThreadID='3128'/><Channel>Microsoft-Windows-Sysmon/Operational</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security UserID='S-1-5-18'/></System><EventData><Data Name='RuleName'></Data><Data Name='UtcTime'>2021-01-14 23:41:39.938</Data><Data Name='ProcessGuid'>{51E9D293-D6B3-6000-0000-001068266601}</Data><Data Name='ProcessId'>6952</Data><Data Name='Image'>C:\Windows\System32\certutil.exe</Data><Data Name='FileVersion'>10.0.14393.2097 (rs1_release_1.180212-1105)</Data><Data Name='Description'>CertUtil.exe</Data><Data Name='Product'>Microsoft® Windows® Operating System</Data><Data Name='Company'>Microsoft Corporation</Data><Data Name='OriginalFileName'>CertUtil.exe</Data><Data Name='CommandLine'>"C:\Windows\system32\certutil.exe" -p password1234 .\powershellcert.pfx</Data><Data Name='CurrentDirectory'>C:\Users\administrator\Desktop\</Data><Data Name='User'>ATTACKRANGE\Administrator</Data><Data Name='LogonGuid'>{51E9D293-57B2-5FFF-0000-002032970400}</Data><Data Name='LogonId'>0x49732</Data><Data Name='TerminalSessionId'>1</Data><Data Name='IntegrityLevel'>High</Data><Data Name='Hashes'>MD5=06210E84C1FA61B0A320559DD458625C,SHA256=2818289572EA6B60681D2724737C3E5C87B3731054F47E9D8E4253D8528D88B7,IMPHASH=442218E88D4D6AA0BE3165DD7B20A4C4</Data><Data Name='ParentProcessGuid'>{51E9D293-D3FD-6000-0000-0010F9096201}</Data><Data Name='ParentProcessId'>6860</Data><Data Name='ParentImage'>C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe</Data><Data Name='ParentCommandLine'>powershell</Data></EventData></Event>
01/14/2021 11:41:39 PM
LogName=Microsoft-Windows-PowerShell/Operational
SourceName=Microsoft-Windows-PowerShell
EventCode=4104
EventType=5
Type=Verbose
ComputerName=win-dc-791937.attackrange.local
User=NOT_TRANSLATED
Sid=S-1-5-21-4072314881-2634547730-233802997-500
SidType=0
TaskCategory=Execute a Remote Command
OpCode=On create calls
RecordNumber=168274
Keywords=None
Message=Creating Scriptblock text (1 of 1):
certutil.exe -p password1234 .\powershellcert.pfx 

ScriptBlock ID: 5a4fa6b8-2478-401a-be72-d1d40c3c754c
Path:
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Security-Auditing' Guid='{54849625-5478-4994-A5BA-3E3B0328C30D}'/><EventID>4688</EventID><Version>2</Version><Level>0</Level><Task>13312</Task><Opcode>0</Opcode><Keywords>0x8020000000000000</Keywords><TimeCreated SystemTime='2021-01-14T23:41:39.938175300Z'/><EventRecordID>309556</EventRecordID><Correlation/><Execution ProcessID='4' ThreadID='164'/><Channel>Security</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security/></System><EventData><Data Name='SubjectUserSid'>ATTACKRANGE\Administrator</Data><Data Name='SubjectUserName'>administrator</Data><Data Name='SubjectDomainName'>ATTACKRANGE</Data><Data Name='SubjectLogonId'>0x49732</Data><Data Name='NewProcessId'>0x1b28</Data><Data Name='NewProcessName'>C:\Windows\System32\certutil.exe</Data><Data Name='TokenElevationType'>%%1936</Data><Data Name='ProcessId'>0x1acc</Data><Data Name='CommandLine'>"C:\Windows\system32\certutil.exe" -p password1234 .\powershellcert.pfx</Data><Data Name='TargetUserSid'>NULL SID</Data><Data Name='TargetUserName'>-</Data><Data Name='TargetDomainName'>-</Data><Data Name='TargetLogonId'>0x0</Data><Data Name='ParentProcessName'>C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe</Data><Data Name='MandatoryLabel'>Mandatory Label\High Mandatory Level</Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Sysmon' Guid='{5770385F-C22A-43E0-BF4C-06F5698FFBD9}'/><EventID>1</EventID><Version>5</Version><Level>4</Level><Task>1</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime='2021-01-14T23:41:09.357986400Z'/><EventRecordID>19683077</EventRecordID><Correlation/><Execution ProcessID='2468' ThreadID='3128'/><Channel>Microsoft-Windows-Sysmon/Operational</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security UserID='S-1-5-18'/></System><EventData><Data Name='RuleName'></Data><Data Name='UtcTime'>2021-01-14 23:41:08.917</Data><Data Name='ProcessGuid'>{51E9D293-D694-6000-0000-00103E086601}</Data><Data Name='ProcessId'>5324</Data><Data Name='Image'>C:\Windows\System32\certutil.exe</Data><Data Name='FileVersion'>10.0.14393.2097 (rs1_release_1.180212-1105)</Data><Data Name='Description'>CertUtil.exe</Data><Data Name='Product'>Microsoft® Windows® Operating System</Data><Data Name='Company'>Microsoft Corporation</Data><Data Name='OriginalFileName'>CertUtil.exe</Data><Data Name='CommandLine'>"C:\Windows\system32\certutil.exe" .\powershellcert.pfx -dump</Data><Data Name='CurrentDirectory'>C:\Users\administrator\Desktop\</Data><Data Name='User'>ATTACKRANGE\Administrator</Data><Data Name='LogonGuid'>{51E9D293-57B2-5FFF-0000-002032970400}</Data><Data Name='LogonId'>0x49732</Data><Data Name='TerminalSessionId'>1</Data><Data Name='IntegrityLevel'>High</Data><Data Name='Hashes'>MD5=06210E84C1FA61B0A320559DD458625C,SHA256=2818289572EA6B60681D2724737C3E5C87B3731054F47E9D8E4253D8528D88B7,IMPHASH=442218E88D4D6AA0BE3165DD7B20A4C4</Data><Data Name='ParentProcessGuid'>{51E9D293-D3FD-6000-0000-0010F9096201}</Data><Data Name='ParentProcessId'>6860</Data><Data Name='ParentImage'>C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe</Data><Data Name='ParentCommandLine'>powershell</Data></EventData></Event>
01/14/2021 11:41:08 PM
LogName=Microsoft-Windows-PowerShell/Operational
SourceName=Microsoft-Windows-PowerShell
EventCode=4104
EventType=5
Type=Verbose
ComputerName=win-dc-791937.attackrange.local
User=NOT_TRANSLATED
Sid=S-1-5-21-4072314881-2634547730-233802997-500
SidType=0
TaskCategory=Execute a Remote Command
OpCode=On create calls
RecordNumber=168262
Keywords=None
Message=Creating Scriptblock text (1 of 1):
certutil.exe .\powershellcert.pfx -dump

ScriptBlock ID: 29402f81-19c5-4b58-aa06-4a5f67f1558f
Path:
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Security-Auditing' Guid='{54849625-5478-4994-A5BA-3E3B0328C30D}'/><EventID>4688</EventID><Version>2</Version><Level>0</Level><Task>13312</Task><Opcode>0</Opcode><Keywords>0x8020000000000000</Keywords><TimeCreated SystemTime='2021-01-14T23:41:08.917859200Z'/><EventRecordID>309552</EventRecordID><Correlation/><Execution ProcessID='4' ThreadID='6088'/><Channel>Security</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security/></System><EventData><Data Name='SubjectUserSid'>ATTACKRANGE\Administrator</Data><Data Name='SubjectUserName'>administrator</Data><Data Name='SubjectDomainName'>ATTACKRANGE</Data><Data Name='SubjectLogonId'>0x49732</Data><Data Name='NewProcessId'>0x14cc</Data><Data Name='NewProcessName'>C:\Windows\System32\certutil.exe</Data><Data Name='TokenElevationType'>%%1936</Data><Data Name='ProcessId'>0x1acc</Data><Data Name='CommandLine'>"C:\Windows\system32\certutil.exe" .\powershellcert.pfx -dump</Data><Data Name='TargetUserSid'>NULL SID</Data><Data Name='TargetUserName'>-</Data><Data Name='TargetDomainName'>-</Data><Data Name='TargetLogonId'>0x0</Data><Data Name='ParentProcessName'>C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe</Data><Data Name='MandatoryLabel'>Mandatory Label\High Mandatory Level</Data></EventData></Event>
01/14/2021 11:40:38 PM
LogName=Microsoft-Windows-PowerShell/Operational
SourceName=Microsoft-Windows-PowerShell
EventCode=4104
EventType=5
Type=Verbose
ComputerName=win-dc-791937.attackrange.local
User=NOT_TRANSLATED
Sid=S-1-5-21-4072314881-2634547730-233802997-500
SidType=0
TaskCategory=Execute a Remote Command
OpCode=On create calls
RecordNumber=168250
Keywords=None
Message=Creating Scriptblock text (1 of 1):
certutil.exe .\powershellcert.pfx

ScriptBlock ID: 33fcbfb3-94c6-444f-b0d1-0cf0e83a0b2e
Path:
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Sysmon' Guid='{5770385F-C22A-43E0-BF4C-06F5698FFBD9}'/><EventID>1</EventID><Version>5</Version><Level>4</Level><Task>1</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime='2021-01-14T23:40:38.790134100Z'/><EventRecordID>19682466</EventRecordID><Correlation/><Execution ProcessID='2468' ThreadID='3128'/><Channel>Microsoft-Windows-Sysmon/Operational</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security UserID='S-1-5-18'/></System><EventData><Data Name='RuleName'></Data><Data Name='UtcTime'>2021-01-14 23:40:38.757</Data><Data Name='ProcessGuid'>{51E9D293-D676-6000-0000-001096F26501}</Data><Data Name='ProcessId'>5824</Data><Data Name='Image'>C:\Windows\System32\certutil.exe</Data><Data Name='FileVersion'>10.0.14393.2097 (rs1_release_1.180212-1105)</Data><Data Name='Description'>CertUtil.exe</Data><Data Name='Product'>Microsoft® Windows® Operating System</Data><Data Name='Company'>Microsoft Corporation</Data><Data Name='OriginalFileName'>CertUtil.exe</Data><Data Name='CommandLine'>"C:\Windows\system32\certutil.exe" .\powershellcert.pfx</Data><Data Name='CurrentDirectory'>C:\Users\administrator\Desktop\</Data><Data Name='User'>ATTACKRANGE\Administrator</Data><Data Name='LogonGuid'>{51E9D293-57B2-5FFF-0000-002032970400}</Data><Data Name='LogonId'>0x49732</Data><Data Name='TerminalSessionId'>1</Data><Data Name='IntegrityLevel'>High</Data><Data Name='Hashes'>MD5=06210E84C1FA61B0A320559DD458625C,SHA256=2818289572EA6B60681D2724737C3E5C87B3731054F47E9D8E4253D8528D88B7,IMPHASH=442218E88D4D6AA0BE3165DD7B20A4C4</Data><Data Name='ParentProcessGuid'>{51E9D293-D3FD-6000-0000-0010F9096201}</Data><Data Name='ParentProcessId'>6860</Data><Data Name='ParentImage'>C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe</Data><Data Name='ParentCommandLine'>powershell</Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Security-Auditing' Guid='{54849625-5478-4994-A5BA-3E3B0328C30D}'/><EventID>4688</EventID><Version>2</Version><Level>0</Level><Task>13312</Task><Opcode>0</Opcode><Keywords>0x8020000000000000</Keywords><TimeCreated SystemTime='2021-01-14T23:40:38.757278200Z'/><EventRecordID>309551</EventRecordID><Correlation/><Execution ProcessID='4' ThreadID='936'/><Channel>Security</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security/></System><EventData><Data Name='SubjectUserSid'>ATTACKRANGE\Administrator</Data><Data Name='SubjectUserName'>administrator</Data><Data Name='SubjectDomainName'>ATTACKRANGE</Data><Data Name='SubjectLogonId'>0x49732</Data><Data Name='NewProcessId'>0x16c0</Data><Data Name='NewProcessName'>C:\Windows\System32\certutil.exe</Data><Data Name='TokenElevationType'>%%1936</Data><Data Name='ProcessId'>0x1acc</Data><Data Name='CommandLine'>"C:\Windows\system32\certutil.exe" .\powershellcert.pfx</Data><Data Name='TargetUserSid'>NULL SID</Data><Data Name='TargetUserName'>-</Data><Data Name='TargetDomainName'>-</Data><Data Name='TargetLogonId'>0x0</Data><Data Name='ParentProcessName'>C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe</Data><Data Name='MandatoryLabel'>Mandatory Label\High Mandatory Level</Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Sysmon' Guid='{5770385F-C22A-43E0-BF4C-06F5698FFBD9}'/><EventID>1</EventID><Version>5</Version><Level>4</Level><Task>1</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime='2021-01-14T23:40:14.150256300Z'/><EventRecordID>19681767</EventRecordID><Correlation/><Execution ProcessID='2468' ThreadID='3128'/><Channel>Microsoft-Windows-Sysmon/Operational</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security UserID='S-1-5-18'/></System><EventData><Data Name='RuleName'></Data><Data Name='UtcTime'>2021-01-14 23:40:13.801</Data><Data Name='ProcessGuid'>{51E9D293-D65D-6000-0000-0010BEC66501}</Data><Data Name='ProcessId'>5412</Data><Data Name='Image'>C:\Windows\System32\rundll32.exe</Data><Data Name='FileVersion'>10.0.14393.0 (rs1_release.160715-1616)</Data><Data Name='Description'>Windows host process (Rundll32)</Data><Data Name='Product'>Microsoft® Windows® Operating System</Data><Data Name='Company'>Microsoft Corporation</Data><Data Name='OriginalFileName'>RUNDLL32.EXE</Data><Data Name='CommandLine'>"C:\Windows\system32\rundll32.exe" cryptext.dll,CryptExtAddPFX C:\Users\administrator\Desktop\powershellcert.pfx</Data><Data Name='CurrentDirectory'>C:\Users\administrator\Desktop\</Data><Data Name='User'>ATTACKRANGE\Administrator</Data><Data Name='LogonGuid'>{51E9D293-57B2-5FFF-0000-002032970400}</Data><Data Name='LogonId'>0x49732</Data><Data Name='TerminalSessionId'>1</Data><Data Name='IntegrityLevel'>High</Data><Data Name='Hashes'>MD5=C7645D43451C6D94D87F4D07BDE59C89,SHA256=495BBA47FC43EE23054FCD419F2F00457162D1C04296900C6AEA551102A810F3,IMPHASH=7D1CE1BAFE48B63D9D19E8E0E5DF3E6C</Data><Data Name='ParentProcessGuid'>{51E9D293-57B5-5FFF-0000-0010FAE00400}</Data><Data Name='ParentProcessId'>4152</Data><Data Name='ParentImage'>C:\Windows\explorer.exe</Data><Data Name='ParentCommandLine'>C:\Windows\Explorer.EXE /NOUACCHECK</Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Security-Auditing' Guid='{54849625-5478-4994-A5BA-3E3B0328C30D}'/><EventID>4688</EventID><Version>2</Version><Level>0</Level><Task>13312</Task><Opcode>0</Opcode><Keywords>0x8020000000000000</Keywords><TimeCreated SystemTime='2021-01-14T23:40:13.801206000Z'/><EventRecordID>309543</EventRecordID><Correlation/><Execution ProcessID='4' ThreadID='5552'/><Channel>Security</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security/></System><EventData><Data Name='SubjectUserSid'>ATTACKRANGE\Administrator</Data><Data Name='SubjectUserName'>administrator</Data><Data Name='SubjectDomainName'>ATTACKRANGE</Data><Data Name='SubjectLogonId'>0x49732</Data><Data Name='NewProcessId'>0x1524</Data><Data Name='NewProcessName'>C:\Windows\System32\rundll32.exe</Data><Data Name='TokenElevationType'>%%1936</Data><Data Name='ProcessId'>0x1038</Data><Data Name='CommandLine'>"C:\Windows\system32\rundll32.exe" cryptext.dll,CryptExtAddPFX C:\Users\administrator\Desktop\powershellcert.pfx</Data><Data Name='TargetUserSid'>NULL SID</Data><Data Name='TargetUserName'>-</Data><Data Name='TargetDomainName'>-</Data><Data Name='TargetLogonId'>0x0</Data><Data Name='ParentProcessName'>C:\Windows\explorer.exe</Data><Data Name='MandatoryLabel'>Mandatory Label\High Mandatory Level</Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Sysmon' Guid='{5770385F-C22A-43E0-BF4C-06F5698FFBD9}'/><EventID>1</EventID><Version>5</Version><Level>4</Level><Task>1</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime='2021-01-13T18:45:43.242979000Z'/><EventRecordID>17976315</EventRecordID><Correlation/><Execution ProcessID='2484' ThreadID='1812'/><Channel>Microsoft-Windows-Sysmon/Operational</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security UserID='S-1-5-18'/></System><EventData><Data Name='RuleName'></Data><Data Name='UtcTime'>2021-01-13 18:45:43.233</Data><Data Name='ProcessGuid'>{51E9D293-3FD7-5FFF-0000-0010003EB603}</Data><Data Name='ProcessId'>1264</Data><Data Name='Image'>C:\Windows\System32\rundll32.exe</Data><Data Name='FileVersion'>10.0.14393.0 (rs1_release.160715-1616)</Data><Data Name='Description'>Windows host process (Rundll32)</Data><Data Name='Product'>Microsoft® Windows® Operating System</Data><Data Name='Company'>Microsoft Corporation</Data><Data Name='OriginalFileName'>RUNDLL32.EXE</Data><Data Name='CommandLine'>"C:\Windows\system32\rundll32.exe" cryptext.dll,CryptExtAddPFX C:\Users\administrator\Desktop\powershellcert.pfx</Data><Data Name='CurrentDirectory'>C:\Users\administrator\Desktop\</Data><Data Name='User'>ATTACKRANGE\Administrator</Data><Data Name='LogonGuid'>{51E9D293-8E61-5FFC-0000-0020D4130F00}</Data><Data Name='LogonId'>0xf13d4</Data><Data Name='TerminalSessionId'>1</Data><Data Name='IntegrityLevel'>High</Data><Data Name='Hashes'>MD5=C7645D43451C6D94D87F4D07BDE59C89,SHA256=495BBA47FC43EE23054FCD419F2F00457162D1C04296900C6AEA551102A810F3,IMPHASH=7D1CE1BAFE48B63D9D19E8E0E5DF3E6C</Data><Data Name='ParentProcessGuid'>{51E9D293-8E65-5FFC-0000-00102A5C0F00}</Data><Data Name='ParentProcessId'>4404</Data><Data Name='ParentImage'>C:\Windows\explorer.exe</Data><Data Name='ParentCommandLine'>C:\Windows\Explorer.EXE /NOUACCHECK</Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Security-Auditing' Guid='{54849625-5478-4994-A5BA-3E3B0328C30D}'/><EventID>4688</EventID><Version>2</Version><Level>0</Level><Task>13312</Task><Opcode>0</Opcode><Keywords>0x8020000000000000</Keywords><TimeCreated SystemTime='2021-01-13T18:45:43.233130400Z'/><EventRecordID>274442</EventRecordID><Correlation/><Execution ProcessID='4' ThreadID='5652'/><Channel>Security</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security/></System><EventData><Data Name='SubjectUserSid'>ATTACKRANGE\Administrator</Data><Data Name='SubjectUserName'>administrator</Data><Data Name='SubjectDomainName'>ATTACKRANGE</Data><Data Name='SubjectLogonId'>0xf13d4</Data><Data Name='NewProcessId'>0x4f0</Data><Data Name='NewProcessName'>C:\Windows\System32\rundll32.exe</Data><Data Name='TokenElevationType'>%%1936</Data><Data Name='ProcessId'>0x1134</Data><Data Name='CommandLine'>"C:\Windows\system32\rundll32.exe" cryptext.dll,CryptExtAddPFX C:\Users\administrator\Desktop\powershellcert.pfx</Data><Data Name='TargetUserSid'>NULL SID</Data><Data Name='TargetUserName'>-</Data><Data Name='TargetDomainName'>-</Data><Data Name='TargetLogonId'>0x0</Data><Data Name='ParentProcessName'>C:\Windows\explorer.exe</Data><Data Name='MandatoryLabel'>Mandatory Label\High Mandatory Level</Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Security-Auditing' Guid='{54849625-5478-4994-A5BA-3E3B0328C30D}'/><EventID>4688</EventID><Version>2</Version><Level>0</Level><Task>13312</Task><Opcode>0</Opcode><Keywords>0x8020000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:46:41.901098000Z'/><EventRecordID>106745</EventRecordID><Correlation/><Execution ProcessID='4' ThreadID='264'/><Channel>Security</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security/></System><EventData><Data Name='SubjectUserSid'>ATTACKRANGE\Administrator</Data><Data Name='SubjectUserName'>administrator</Data><Data Name='SubjectDomainName'>ATTACKRANGE</Data><Data Name='SubjectLogonId'>0x4b394</Data><Data Name='NewProcessId'>0x1218</Data><Data Name='NewProcessName'>C:\Windows\System32\certutil.exe</Data><Data Name='TokenElevationType'>%%1936</Data><Data Name='ProcessId'>0x16fc</Data><Data Name='CommandLine'>certutil  -dump powershellcert.pfx</Data><Data Name='TargetUserSid'>NULL SID</Data><Data Name='TargetUserName'>-</Data><Data Name='TargetDomainName'>-</Data><Data Name='TargetLogonId'>0x0</Data><Data Name='ParentProcessName'>C:\Windows\System32\cmd.exe</Data><Data Name='MandatoryLabel'>Mandatory Label\High Mandatory Level</Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Sysmon' Guid='{5770385F-C22A-43E0-BF4C-06F5698FFBD9}'/><EventID>1</EventID><Version>5</Version><Level>4</Level><Task>1</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:46:41.904136200Z'/><EventRecordID>6262828</EventRecordID><Correlation/><Execution ProcessID='2436' ThreadID='2996'/><Channel>Microsoft-Windows-Sysmon/Operational</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security UserID='S-1-5-18'/></System><EventData><Data Name='RuleName'></Data><Data Name='UtcTime'>2021-01-07 15:46:41.901</Data><Data Name='ProcessGuid'>{51E9D293-2CE1-5FF7-0000-0010D7D71300}</Data><Data Name='ProcessId'>4632</Data><Data Name='Image'>C:\Windows\System32\certutil.exe</Data><Data Name='FileVersion'>10.0.14393.2097 (rs1_release_1.180212-1105)</Data><Data Name='Description'>CertUtil.exe</Data><Data Name='Product'>Microsoft® Windows® Operating System</Data><Data Name='Company'>Microsoft Corporation</Data><Data Name='OriginalFileName'>CertUtil.exe</Data><Data Name='CommandLine'>certutil  -dump powershellcert.pfx</Data><Data Name='CurrentDirectory'>c:\Users\administrator\Desktop\</Data><Data Name='User'>ATTACKRANGE\Administrator</Data><Data Name='LogonGuid'>{51E9D293-2892-5FF7-0000-002094B30400}</Data><Data Name='LogonId'>0x4b394</Data><Data Name='TerminalSessionId'>1</Data><Data Name='IntegrityLevel'>High</Data><Data Name='Hashes'>MD5=06210E84C1FA61B0A320559DD458625C,SHA256=2818289572EA6B60681D2724737C3E5C87B3731054F47E9D8E4253D8528D88B7,IMPHASH=442218E88D4D6AA0BE3165DD7B20A4C4</Data><Data Name='ParentProcessGuid'>{51E9D293-2A16-5FF7-0000-001040D20B00}</Data><Data Name='ParentProcessId'>5884</Data><Data Name='ParentImage'>C:\Windows\System32\cmd.exe</Data><Data Name='ParentCommandLine'>"C:\Windows\system32\cmd.exe" </Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Security-Auditing' Guid='{54849625-5478-4994-A5BA-3E3B0328C30D}'/><EventID>4688</EventID><Version>2</Version><Level>0</Level><Task>13312</Task><Opcode>0</Opcode><Keywords>0x8020000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:43:12.681564800Z'/><EventRecordID>106637</EventRecordID><Correlation/><Execution ProcessID='4' ThreadID='260'/><Channel>Security</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security/></System><EventData><Data Name='SubjectUserSid'>ATTACKRANGE\Administrator</Data><Data Name='SubjectUserName'>administrator</Data><Data Name='SubjectDomainName'>ATTACKRANGE</Data><Data Name='SubjectLogonId'>0x4b394</Data><Data Name='NewProcessId'>0x16b4</Data><Data Name='NewProcessName'>C:\Windows\System32\certutil.exe</Data><Data Name='TokenElevationType'>%%1936</Data><Data Name='ProcessId'>0x16fc</Data><Data Name='CommandLine'>certutil.exe  -p password1234 -exportPFX powershellcert.pfx </Data><Data Name='TargetUserSid'>NULL SID</Data><Data Name='TargetUserName'>-</Data><Data Name='TargetDomainName'>-</Data><Data Name='TargetLogonId'>0x0</Data><Data Name='ParentProcessName'>C:\Windows\System32\cmd.exe</Data><Data Name='MandatoryLabel'>Mandatory Label\High Mandatory Level</Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Sysmon' Guid='{5770385F-C22A-43E0-BF4C-06F5698FFBD9}'/><EventID>1</EventID><Version>5</Version><Level>4</Level><Task>1</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:43:12.695975200Z'/><EventRecordID>6254618</EventRecordID><Correlation/><Execution ProcessID='2436' ThreadID='2996'/><Channel>Microsoft-Windows-Sysmon/Operational</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security UserID='S-1-5-18'/></System><EventData><Data Name='RuleName'></Data><Data Name='UtcTime'>2021-01-07 15:43:12.681</Data><Data Name='ProcessGuid'>{51E9D293-2C10-5FF7-0000-0010CB181200}</Data><Data Name='ProcessId'>5812</Data><Data Name='Image'>C:\Windows\System32\certutil.exe</Data><Data Name='FileVersion'>10.0.14393.2097 (rs1_release_1.180212-1105)</Data><Data Name='Description'>CertUtil.exe</Data><Data Name='Product'>Microsoft® Windows® Operating System</Data><Data Name='Company'>Microsoft Corporation</Data><Data Name='OriginalFileName'>CertUtil.exe</Data><Data Name='CommandLine'>certutil.exe  -p password1234 -exportPFX powershellcert.pfx </Data><Data Name='CurrentDirectory'>c:\Users\administrator\Desktop\</Data><Data Name='User'>ATTACKRANGE\Administrator</Data><Data Name='LogonGuid'>{51E9D293-2892-5FF7-0000-002094B30400}</Data><Data Name='LogonId'>0x4b394</Data><Data Name='TerminalSessionId'>1</Data><Data Name='IntegrityLevel'>High</Data><Data Name='Hashes'>MD5=06210E84C1FA61B0A320559DD458625C,SHA256=2818289572EA6B60681D2724737C3E5C87B3731054F47E9D8E4253D8528D88B7,IMPHASH=442218E88D4D6AA0BE3165DD7B20A4C4</Data><Data Name='ParentProcessGuid'>{51E9D293-2A16-5FF7-0000-001040D20B00}</Data><Data Name='ParentProcessId'>5884</Data><Data Name='ParentImage'>C:\Windows\System32\cmd.exe</Data><Data Name='ParentCommandLine'>"C:\Windows\system32\cmd.exe" </Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Security-Auditing' Guid='{54849625-5478-4994-A5BA-3E3B0328C30D}'/><EventID>4688</EventID><Version>2</Version><Level>0</Level><Task>13312</Task><Opcode>0</Opcode><Keywords>0x8020000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:42:59.899969400Z'/><EventRecordID>106636</EventRecordID><Correlation/><Execution ProcessID='4' ThreadID='92'/><Channel>Security</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security/></System><EventData><Data Name='SubjectUserSid'>ATTACKRANGE\Administrator</Data><Data Name='SubjectUserName'>administrator</Data><Data Name='SubjectDomainName'>ATTACKRANGE</Data><Data Name='SubjectLogonId'>0x4b394</Data><Data Name='NewProcessId'>0x1334</Data><Data Name='NewProcessName'>C:\Windows\System32\certutil.exe</Data><Data Name='TokenElevationType'>%%1936</Data><Data Name='ProcessId'>0x16fc</Data><Data Name='CommandLine'>certutil.exe  -p -exportPFX powershellcert.pfx </Data><Data Name='TargetUserSid'>NULL SID</Data><Data Name='TargetUserName'>-</Data><Data Name='TargetDomainName'>-</Data><Data Name='TargetLogonId'>0x0</Data><Data Name='ParentProcessName'>C:\Windows\System32\cmd.exe</Data><Data Name='MandatoryLabel'>Mandatory Label\High Mandatory Level</Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Sysmon' Guid='{5770385F-C22A-43E0-BF4C-06F5698FFBD9}'/><EventID>1</EventID><Version>5</Version><Level>4</Level><Task>1</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:42:59.903075600Z'/><EventRecordID>6254259</EventRecordID><Correlation/><Execution ProcessID='2436' ThreadID='2996'/><Channel>Microsoft-Windows-Sysmon/Operational</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security UserID='S-1-5-18'/></System><EventData><Data Name='RuleName'></Data><Data Name='UtcTime'>2021-01-07 15:42:59.899</Data><Data Name='ProcessGuid'>{51E9D293-2C03-5FF7-0000-0010B8091200}</Data><Data Name='ProcessId'>4916</Data><Data Name='Image'>C:\Windows\System32\certutil.exe</Data><Data Name='FileVersion'>10.0.14393.2097 (rs1_release_1.180212-1105)</Data><Data Name='Description'>CertUtil.exe</Data><Data Name='Product'>Microsoft® Windows® Operating System</Data><Data Name='Company'>Microsoft Corporation</Data><Data Name='OriginalFileName'>CertUtil.exe</Data><Data Name='CommandLine'>certutil.exe  -p -exportPFX powershellcert.pfx </Data><Data Name='CurrentDirectory'>c:\Users\administrator\Desktop\</Data><Data Name='User'>ATTACKRANGE\Administrator</Data><Data Name='LogonGuid'>{51E9D293-2892-5FF7-0000-002094B30400}</Data><Data Name='LogonId'>0x4b394</Data><Data Name='TerminalSessionId'>1</Data><Data Name='IntegrityLevel'>High</Data><Data Name='Hashes'>MD5=06210E84C1FA61B0A320559DD458625C,SHA256=2818289572EA6B60681D2724737C3E5C87B3731054F47E9D8E4253D8528D88B7,IMPHASH=442218E88D4D6AA0BE3165DD7B20A4C4</Data><Data Name='ParentProcessGuid'>{51E9D293-2A16-5FF7-0000-001040D20B00}</Data><Data Name='ParentProcessId'>5884</Data><Data Name='ParentImage'>C:\Windows\System32\cmd.exe</Data><Data Name='ParentCommandLine'>"C:\Windows\system32\cmd.exe" </Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Security-Auditing' Guid='{54849625-5478-4994-A5BA-3E3B0328C30D}'/><EventID>4688</EventID><Version>2</Version><Level>0</Level><Task>13312</Task><Opcode>0</Opcode><Keywords>0x8020000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:42:54.120593300Z'/><EventRecordID>106633</EventRecordID><Correlation/><Execution ProcessID='4' ThreadID='92'/><Channel>Security</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security/></System><EventData><Data Name='SubjectUserSid'>ATTACKRANGE\Administrator</Data><Data Name='SubjectUserName'>administrator</Data><Data Name='SubjectDomainName'>ATTACKRANGE</Data><Data Name='SubjectLogonId'>0x4b394</Data><Data Name='NewProcessId'>0x208</Data><Data Name='NewProcessName'>C:\Windows\System32\certutil.exe</Data><Data Name='TokenElevationType'>%%1936</Data><Data Name='ProcessId'>0x16fc</Data><Data Name='CommandLine'>certutil.exe  -exportPFX powershellcert.pfx </Data><Data Name='TargetUserSid'>NULL SID</Data><Data Name='TargetUserName'>-</Data><Data Name='TargetDomainName'>-</Data><Data Name='TargetLogonId'>0x0</Data><Data Name='ParentProcessName'>C:\Windows\System32\cmd.exe</Data><Data Name='MandatoryLabel'>Mandatory Label\High Mandatory Level</Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Sysmon' Guid='{5770385F-C22A-43E0-BF4C-06F5698FFBD9}'/><EventID>1</EventID><Version>5</Version><Level>4</Level><Task>1</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:42:54.260007400Z'/><EventRecordID>6253886</EventRecordID><Correlation/><Execution ProcessID='2436' ThreadID='2996'/><Channel>Microsoft-Windows-Sysmon/Operational</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security UserID='S-1-5-18'/></System><EventData><Data Name='RuleName'></Data><Data Name='UtcTime'>2021-01-07 15:42:54.120</Data><Data Name='ProcessGuid'>{51E9D293-2BFE-5FF7-0000-001013F81100}</Data><Data Name='ProcessId'>520</Data><Data Name='Image'>C:\Windows\System32\certutil.exe</Data><Data Name='FileVersion'>10.0.14393.2097 (rs1_release_1.180212-1105)</Data><Data Name='Description'>CertUtil.exe</Data><Data Name='Product'>Microsoft® Windows® Operating System</Data><Data Name='Company'>Microsoft Corporation</Data><Data Name='OriginalFileName'>CertUtil.exe</Data><Data Name='CommandLine'>certutil.exe  -exportPFX powershellcert.pfx </Data><Data Name='CurrentDirectory'>c:\Users\administrator\Desktop\</Data><Data Name='User'>ATTACKRANGE\Administrator</Data><Data Name='LogonGuid'>{51E9D293-2892-5FF7-0000-002094B30400}</Data><Data Name='LogonId'>0x4b394</Data><Data Name='TerminalSessionId'>1</Data><Data Name='IntegrityLevel'>High</Data><Data Name='Hashes'>MD5=06210E84C1FA61B0A320559DD458625C,SHA256=2818289572EA6B60681D2724737C3E5C87B3731054F47E9D8E4253D8528D88B7,IMPHASH=442218E88D4D6AA0BE3165DD7B20A4C4</Data><Data Name='ParentProcessGuid'>{51E9D293-2A16-5FF7-0000-001040D20B00}</Data><Data Name='ParentProcessId'>5884</Data><Data Name='ParentImage'>C:\Windows\System32\cmd.exe</Data><Data Name='ParentCommandLine'>"C:\Windows\system32\cmd.exe" </Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Security-Auditing' Guid='{54849625-5478-4994-A5BA-3E3B0328C30D}'/><EventID>4688</EventID><Version>2</Version><Level>0</Level><Task>13312</Task><Opcode>0</Opcode><Keywords>0x8020000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:42:44.974766600Z'/><EventRecordID>106606</EventRecordID><Correlation/><Execution ProcessID='4' ThreadID='2196'/><Channel>Security</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security/></System><EventData><Data Name='SubjectUserSid'>ATTACKRANGE\Administrator</Data><Data Name='SubjectUserName'>administrator</Data><Data Name='SubjectDomainName'>ATTACKRANGE</Data><Data Name='SubjectLogonId'>0x4b394</Data><Data Name='NewProcessId'>0x11d0</Data><Data Name='NewProcessName'>C:\Windows\System32\certutil.exe</Data><Data Name='TokenElevationType'>%%1936</Data><Data Name='ProcessId'>0x16fc</Data><Data Name='CommandLine'>certutil.exe  -exportPFX powershellcert.pfx -p</Data><Data Name='TargetUserSid'>NULL SID</Data><Data Name='TargetUserName'>-</Data><Data Name='TargetDomainName'>-</Data><Data Name='TargetLogonId'>0x0</Data><Data Name='ParentProcessName'>C:\Windows\System32\cmd.exe</Data><Data Name='MandatoryLabel'>Mandatory Label\High Mandatory Level</Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Sysmon' Guid='{5770385F-C22A-43E0-BF4C-06F5698FFBD9}'/><EventID>1</EventID><Version>5</Version><Level>4</Level><Task>1</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:42:44.978424000Z'/><EventRecordID>6253650</EventRecordID><Correlation/><Execution ProcessID='2436' ThreadID='2996'/><Channel>Microsoft-Windows-Sysmon/Operational</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security UserID='S-1-5-18'/></System><EventData><Data Name='RuleName'></Data><Data Name='UtcTime'>2021-01-07 15:42:44.974</Data><Data Name='ProcessGuid'>{51E9D293-2BF4-5FF7-0000-001011DA1100}</Data><Data Name='ProcessId'>4560</Data><Data Name='Image'>C:\Windows\System32\certutil.exe</Data><Data Name='FileVersion'>10.0.14393.2097 (rs1_release_1.180212-1105)</Data><Data Name='Description'>CertUtil.exe</Data><Data Name='Product'>Microsoft® Windows® Operating System</Data><Data Name='Company'>Microsoft Corporation</Data><Data Name='OriginalFileName'>CertUtil.exe</Data><Data Name='CommandLine'>certutil.exe  -exportPFX powershellcert.pfx -p</Data><Data Name='CurrentDirectory'>c:\Users\administrator\Desktop\</Data><Data Name='User'>ATTACKRANGE\Administrator</Data><Data Name='LogonGuid'>{51E9D293-2892-5FF7-0000-002094B30400}</Data><Data Name='LogonId'>0x4b394</Data><Data Name='TerminalSessionId'>1</Data><Data Name='IntegrityLevel'>High</Data><Data Name='Hashes'>MD5=06210E84C1FA61B0A320559DD458625C,SHA256=2818289572EA6B60681D2724737C3E5C87B3731054F47E9D8E4253D8528D88B7,IMPHASH=442218E88D4D6AA0BE3165DD7B20A4C4</Data><Data Name='ParentProcessGuid'>{51E9D293-2A16-5FF7-0000-001040D20B00}</Data><Data Name='ParentProcessId'>5884</Data><Data Name='ParentImage'>C:\Windows\System32\cmd.exe</Data><Data Name='ParentCommandLine'>"C:\Windows\system32\cmd.exe" </Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Security-Auditing' Guid='{54849625-5478-4994-A5BA-3E3B0328C30D}'/><EventID>4688</EventID><Version>2</Version><Level>0</Level><Task>13312</Task><Opcode>0</Opcode><Keywords>0x8020000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:41:24.467950200Z'/><EventRecordID>106559</EventRecordID><Correlation/><Execution ProcessID='4' ThreadID='1296'/><Channel>Security</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security/></System><EventData><Data Name='SubjectUserSid'>ATTACKRANGE\Administrator</Data><Data Name='SubjectUserName'>administrator</Data><Data Name='SubjectDomainName'>ATTACKRANGE</Data><Data Name='SubjectLogonId'>0x4b394</Data><Data Name='NewProcessId'>0x5f8</Data><Data Name='NewProcessName'>C:\Windows\System32\certutil.exe</Data><Data Name='TokenElevationType'>%%1936</Data><Data Name='ProcessId'>0x16fc</Data><Data Name='CommandLine'>certutil.exe  -exportPFX powershellcert.pfx -?</Data><Data Name='TargetUserSid'>NULL SID</Data><Data Name='TargetUserName'>-</Data><Data Name='TargetDomainName'>-</Data><Data Name='TargetLogonId'>0x0</Data><Data Name='ParentProcessName'>C:\Windows\System32\cmd.exe</Data><Data Name='MandatoryLabel'>Mandatory Label\High Mandatory Level</Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Sysmon' Guid='{5770385F-C22A-43E0-BF4C-06F5698FFBD9}'/><EventID>1</EventID><Version>5</Version><Level>4</Level><Task>1</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:41:24.494531100Z'/><EventRecordID>6250689</EventRecordID><Correlation/><Execution ProcessID='2436' ThreadID='2996'/><Channel>Microsoft-Windows-Sysmon/Operational</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security UserID='S-1-5-18'/></System><EventData><Data Name='RuleName'></Data><Data Name='UtcTime'>2021-01-07 15:41:24.467</Data><Data Name='ProcessGuid'>{51E9D293-2BA4-5FF7-0000-0010CE001100}</Data><Data Name='ProcessId'>1528</Data><Data Name='Image'>C:\Windows\System32\certutil.exe</Data><Data Name='FileVersion'>10.0.14393.2097 (rs1_release_1.180212-1105)</Data><Data Name='Description'>CertUtil.exe</Data><Data Name='Product'>Microsoft® Windows® Operating System</Data><Data Name='Company'>Microsoft Corporation</Data><Data Name='OriginalFileName'>CertUtil.exe</Data><Data Name='CommandLine'>certutil.exe  -exportPFX powershellcert.pfx -?</Data><Data Name='CurrentDirectory'>c:\Users\administrator\Desktop\</Data><Data Name='User'>ATTACKRANGE\Administrator</Data><Data Name='LogonGuid'>{51E9D293-2892-5FF7-0000-002094B30400}</Data><Data Name='LogonId'>0x4b394</Data><Data Name='TerminalSessionId'>1</Data><Data Name='IntegrityLevel'>High</Data><Data Name='Hashes'>MD5=06210E84C1FA61B0A320559DD458625C,SHA256=2818289572EA6B60681D2724737C3E5C87B3731054F47E9D8E4253D8528D88B7,IMPHASH=442218E88D4D6AA0BE3165DD7B20A4C4</Data><Data Name='ParentProcessGuid'>{51E9D293-2A16-5FF7-0000-001040D20B00}</Data><Data Name='ParentProcessId'>5884</Data><Data Name='ParentImage'>C:\Windows\System32\cmd.exe</Data><Data Name='ParentCommandLine'>"C:\Windows\system32\cmd.exe" </Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Security-Auditing' Guid='{54849625-5478-4994-A5BA-3E3B0328C30D}'/><EventID>4688</EventID><Version>2</Version><Level>0</Level><Task>13312</Task><Opcode>0</Opcode><Keywords>0x8020000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:41:09.385370300Z'/><EventRecordID>106555</EventRecordID><Correlation/><Execution ProcessID='4' ThreadID='256'/><Channel>Security</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security/></System><EventData><Data Name='SubjectUserSid'>ATTACKRANGE\Administrator</Data><Data Name='SubjectUserName'>administrator</Data><Data Name='SubjectDomainName'>ATTACKRANGE</Data><Data Name='SubjectLogonId'>0x4b394</Data><Data Name='NewProcessId'>0x1710</Data><Data Name='NewProcessName'>C:\Windows\System32\certutil.exe</Data><Data Name='TokenElevationType'>%%1936</Data><Data Name='ProcessId'>0x16fc</Data><Data Name='CommandLine'>certutil.exe  -exportPFX powershellcert.pfx </Data><Data Name='TargetUserSid'>NULL SID</Data><Data Name='TargetUserName'>-</Data><Data Name='TargetDomainName'>-</Data><Data Name='TargetLogonId'>0x0</Data><Data Name='ParentProcessName'>C:\Windows\System32\cmd.exe</Data><Data Name='MandatoryLabel'>Mandatory Label\High Mandatory Level</Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Sysmon' Guid='{5770385F-C22A-43E0-BF4C-06F5698FFBD9}'/><EventID>1</EventID><Version>5</Version><Level>4</Level><Task>1</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:41:09.388493100Z'/><EventRecordID>6250144</EventRecordID><Correlation/><Execution ProcessID='2436' ThreadID='2996'/><Channel>Microsoft-Windows-Sysmon/Operational</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security UserID='S-1-5-18'/></System><EventData><Data Name='RuleName'></Data><Data Name='UtcTime'>2021-01-07 15:41:09.385</Data><Data Name='ProcessGuid'>{51E9D293-2B95-5FF7-0000-0010BFB31000}</Data><Data Name='ProcessId'>5904</Data><Data Name='Image'>C:\Windows\System32\certutil.exe</Data><Data Name='FileVersion'>10.0.14393.2097 (rs1_release_1.180212-1105)</Data><Data Name='Description'>CertUtil.exe</Data><Data Name='Product'>Microsoft® Windows® Operating System</Data><Data Name='Company'>Microsoft Corporation</Data><Data Name='OriginalFileName'>CertUtil.exe</Data><Data Name='CommandLine'>certutil.exe  -exportPFX powershellcert.pfx </Data><Data Name='CurrentDirectory'>c:\Users\administrator\Desktop\</Data><Data Name='User'>ATTACKRANGE\Administrator</Data><Data Name='LogonGuid'>{51E9D293-2892-5FF7-0000-002094B30400}</Data><Data Name='LogonId'>0x4b394</Data><Data Name='TerminalSessionId'>1</Data><Data Name='IntegrityLevel'>High</Data><Data Name='Hashes'>MD5=06210E84C1FA61B0A320559DD458625C,SHA256=2818289572EA6B60681D2724737C3E5C87B3731054F47E9D8E4253D8528D88B7,IMPHASH=442218E88D4D6AA0BE3165DD7B20A4C4</Data><Data Name='ParentProcessGuid'>{51E9D293-2A16-5FF7-0000-001040D20B00}</Data><Data Name='ParentProcessId'>5884</Data><Data Name='ParentImage'>C:\Windows\System32\cmd.exe</Data><Data Name='ParentCommandLine'>"C:\Windows\system32\cmd.exe" </Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Security-Auditing' Guid='{54849625-5478-4994-A5BA-3E3B0328C30D}'/><EventID>4688</EventID><Version>2</Version><Level>0</Level><Task>13312</Task><Opcode>0</Opcode><Keywords>0x8020000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:41:01.786509100Z'/><EventRecordID>106554</EventRecordID><Correlation/><Execution ProcessID='4' ThreadID='164'/><Channel>Security</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security/></System><EventData><Data Name='SubjectUserSid'>ATTACKRANGE\Administrator</Data><Data Name='SubjectUserName'>administrator</Data><Data Name='SubjectDomainName'>ATTACKRANGE</Data><Data Name='SubjectLogonId'>0x4b394</Data><Data Name='NewProcessId'>0x1458</Data><Data Name='NewProcessName'>C:\Windows\System32\certutil.exe</Data><Data Name='TokenElevationType'>%%1936</Data><Data Name='ProcessId'>0x16fc</Data><Data Name='CommandLine'>certutil.exe  -exportPFX  powershellcert.pfx </Data><Data Name='TargetUserSid'>NULL SID</Data><Data Name='TargetUserName'>-</Data><Data Name='TargetDomainName'>-</Data><Data Name='TargetLogonId'>0x0</Data><Data Name='ParentProcessName'>C:\Windows\System32\cmd.exe</Data><Data Name='MandatoryLabel'>Mandatory Label\High Mandatory Level</Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Sysmon' Guid='{5770385F-C22A-43E0-BF4C-06F5698FFBD9}'/><EventID>1</EventID><Version>5</Version><Level>4</Level><Task>1</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:41:01.788563400Z'/><EventRecordID>6249779</EventRecordID><Correlation/><Execution ProcessID='2436' ThreadID='2996'/><Channel>Microsoft-Windows-Sysmon/Operational</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security UserID='S-1-5-18'/></System><EventData><Data Name='RuleName'></Data><Data Name='UtcTime'>2021-01-07 15:41:01.786</Data><Data Name='ProcessGuid'>{51E9D293-2B8D-5FF7-0000-0010DDA21000}</Data><Data Name='ProcessId'>5208</Data><Data Name='Image'>C:\Windows\System32\certutil.exe</Data><Data Name='FileVersion'>10.0.14393.2097 (rs1_release_1.180212-1105)</Data><Data Name='Description'>CertUtil.exe</Data><Data Name='Product'>Microsoft® Windows® Operating System</Data><Data Name='Company'>Microsoft Corporation</Data><Data Name='OriginalFileName'>CertUtil.exe</Data><Data Name='CommandLine'>certutil.exe  -exportPFX  powershellcert.pfx </Data><Data Name='CurrentDirectory'>c:\Users\administrator\Desktop\</Data><Data Name='User'>ATTACKRANGE\Administrator</Data><Data Name='LogonGuid'>{51E9D293-2892-5FF7-0000-002094B30400}</Data><Data Name='LogonId'>0x4b394</Data><Data Name='TerminalSessionId'>1</Data><Data Name='IntegrityLevel'>High</Data><Data Name='Hashes'>MD5=06210E84C1FA61B0A320559DD458625C,SHA256=2818289572EA6B60681D2724737C3E5C87B3731054F47E9D8E4253D8528D88B7,IMPHASH=442218E88D4D6AA0BE3165DD7B20A4C4</Data><Data Name='ParentProcessGuid'>{51E9D293-2A16-5FF7-0000-001040D20B00}</Data><Data Name='ParentProcessId'>5884</Data><Data Name='ParentImage'>C:\Windows\System32\cmd.exe</Data><Data Name='ParentCommandLine'>"C:\Windows\system32\cmd.exe" </Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Security-Auditing' Guid='{54849625-5478-4994-A5BA-3E3B0328C30D}'/><EventID>4688</EventID><Version>2</Version><Level>0</Level><Task>13312</Task><Opcode>0</Opcode><Keywords>0x8020000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:40:52.800197700Z'/><EventRecordID>106550</EventRecordID><Correlation/><Execution ProcessID='4' ThreadID='92'/><Channel>Security</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security/></System><EventData><Data Name='SubjectUserSid'>ATTACKRANGE\Administrator</Data><Data Name='SubjectUserName'>administrator</Data><Data Name='SubjectDomainName'>ATTACKRANGE</Data><Data Name='SubjectLogonId'>0x4b394</Data><Data Name='NewProcessId'>0xb4c</Data><Data Name='NewProcessName'>C:\Windows\System32\certutil.exe</Data><Data Name='TokenElevationType'>%%1936</Data><Data Name='ProcessId'>0x16fc</Data><Data Name='CommandLine'>certutil.exe  -exportpfx  powershellcert.pfx </Data><Data Name='TargetUserSid'>NULL SID</Data><Data Name='TargetUserName'>-</Data><Data Name='TargetDomainName'>-</Data><Data Name='TargetLogonId'>0x0</Data><Data Name='ParentProcessName'>C:\Windows\System32\cmd.exe</Data><Data Name='MandatoryLabel'>Mandatory Label\High Mandatory Level</Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Sysmon' Guid='{5770385F-C22A-43E0-BF4C-06F5698FFBD9}'/><EventID>1</EventID><Version>5</Version><Level>4</Level><Task>1</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:40:52.825312400Z'/><EventRecordID>6249557</EventRecordID><Correlation/><Execution ProcessID='2436' ThreadID='2996'/><Channel>Microsoft-Windows-Sysmon/Operational</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security UserID='S-1-5-18'/></System><EventData><Data Name='RuleName'></Data><Data Name='UtcTime'>2021-01-07 15:40:52.800</Data><Data Name='ProcessGuid'>{51E9D293-2B84-5FF7-0000-0010998A1000}</Data><Data Name='ProcessId'>2892</Data><Data Name='Image'>C:\Windows\System32\certutil.exe</Data><Data Name='FileVersion'>10.0.14393.2097 (rs1_release_1.180212-1105)</Data><Data Name='Description'>CertUtil.exe</Data><Data Name='Product'>Microsoft® Windows® Operating System</Data><Data Name='Company'>Microsoft Corporation</Data><Data Name='OriginalFileName'>CertUtil.exe</Data><Data Name='CommandLine'>certutil.exe  -exportpfx  powershellcert.pfx </Data><Data Name='CurrentDirectory'>c:\Users\administrator\Desktop\</Data><Data Name='User'>ATTACKRANGE\Administrator</Data><Data Name='LogonGuid'>{51E9D293-2892-5FF7-0000-002094B30400}</Data><Data Name='LogonId'>0x4b394</Data><Data Name='TerminalSessionId'>1</Data><Data Name='IntegrityLevel'>High</Data><Data Name='Hashes'>MD5=06210E84C1FA61B0A320559DD458625C,SHA256=2818289572EA6B60681D2724737C3E5C87B3731054F47E9D8E4253D8528D88B7,IMPHASH=442218E88D4D6AA0BE3165DD7B20A4C4</Data><Data Name='ParentProcessGuid'>{51E9D293-2A16-5FF7-0000-001040D20B00}</Data><Data Name='ParentProcessId'>5884</Data><Data Name='ParentImage'>C:\Windows\System32\cmd.exe</Data><Data Name='ParentCommandLine'>"C:\Windows\system32\cmd.exe" </Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Security-Auditing' Guid='{54849625-5478-4994-A5BA-3E3B0328C30D}'/><EventID>4688</EventID><Version>2</Version><Level>0</Level><Task>13312</Task><Opcode>0</Opcode><Keywords>0x8020000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:39:35.348533000Z'/><EventRecordID>106491</EventRecordID><Correlation/><Execution ProcessID='4' ThreadID='260'/><Channel>Security</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security/></System><EventData><Data Name='SubjectUserSid'>ATTACKRANGE\Administrator</Data><Data Name='SubjectUserName'>administrator</Data><Data Name='SubjectDomainName'>ATTACKRANGE</Data><Data Name='SubjectLogonId'>0x4b394</Data><Data Name='NewProcessId'>0xe70</Data><Data Name='NewProcessName'>C:\Windows\System32\certutil.exe</Data><Data Name='TokenElevationType'>%%1936</Data><Data Name='ProcessId'>0x16fc</Data><Data Name='CommandLine'>certutil.exe  -privatekey  powershellcert.pfx </Data><Data Name='TargetUserSid'>NULL SID</Data><Data Name='TargetUserName'>-</Data><Data Name='TargetDomainName'>-</Data><Data Name='TargetLogonId'>0x0</Data><Data Name='ParentProcessName'>C:\Windows\System32\cmd.exe</Data><Data Name='MandatoryLabel'>Mandatory Label\High Mandatory Level</Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Sysmon' Guid='{5770385F-C22A-43E0-BF4C-06F5698FFBD9}'/><EventID>1</EventID><Version>5</Version><Level>4</Level><Task>1</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:39:35.350718900Z'/><EventRecordID>6245979</EventRecordID><Correlation/><Execution ProcessID='2436' ThreadID='2996'/><Channel>Microsoft-Windows-Sysmon/Operational</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security UserID='S-1-5-18'/></System><EventData><Data Name='RuleName'></Data><Data Name='UtcTime'>2021-01-07 15:39:35.348</Data><Data Name='ProcessGuid'>{51E9D293-2B37-5FF7-0000-00102CB30F00}</Data><Data Name='ProcessId'>3696</Data><Data Name='Image'>C:\Windows\System32\certutil.exe</Data><Data Name='FileVersion'>10.0.14393.2097 (rs1_release_1.180212-1105)</Data><Data Name='Description'>CertUtil.exe</Data><Data Name='Product'>Microsoft® Windows® Operating System</Data><Data Name='Company'>Microsoft Corporation</Data><Data Name='OriginalFileName'>CertUtil.exe</Data><Data Name='CommandLine'>certutil.exe  -privatekey  powershellcert.pfx </Data><Data Name='CurrentDirectory'>c:\Users\administrator\Desktop\</Data><Data Name='User'>ATTACKRANGE\Administrator</Data><Data Name='LogonGuid'>{51E9D293-2892-5FF7-0000-002094B30400}</Data><Data Name='LogonId'>0x4b394</Data><Data Name='TerminalSessionId'>1</Data><Data Name='IntegrityLevel'>High</Data><Data Name='Hashes'>MD5=06210E84C1FA61B0A320559DD458625C,SHA256=2818289572EA6B60681D2724737C3E5C87B3731054F47E9D8E4253D8528D88B7,IMPHASH=442218E88D4D6AA0BE3165DD7B20A4C4</Data><Data Name='ParentProcessGuid'>{51E9D293-2A16-5FF7-0000-001040D20B00}</Data><Data Name='ParentProcessId'>5884</Data><Data Name='ParentImage'>C:\Windows\System32\cmd.exe</Data><Data Name='ParentCommandLine'>"C:\Windows\system32\cmd.exe" </Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Security-Auditing' Guid='{54849625-5478-4994-A5BA-3E3B0328C30D}'/><EventID>4688</EventID><Version>2</Version><Level>0</Level><Task>13312</Task><Opcode>0</Opcode><Keywords>0x8020000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:39:21.793643200Z'/><EventRecordID>106489</EventRecordID><Correlation/><Execution ProcessID='4' ThreadID='2196'/><Channel>Security</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security/></System><EventData><Data Name='SubjectUserSid'>ATTACKRANGE\Administrator</Data><Data Name='SubjectUserName'>administrator</Data><Data Name='SubjectDomainName'>ATTACKRANGE</Data><Data Name='SubjectLogonId'>0x4b394</Data><Data Name='NewProcessId'>0x1364</Data><Data Name='NewProcessName'>C:\Windows\System32\certutil.exe</Data><Data Name='TokenElevationType'>%%1936</Data><Data Name='ProcessId'>0x16fc</Data><Data Name='CommandLine'>certutil.exe  -privatekey -exportpfx  powershellcert.pfx </Data><Data Name='TargetUserSid'>NULL SID</Data><Data Name='TargetUserName'>-</Data><Data Name='TargetDomainName'>-</Data><Data Name='TargetLogonId'>0x0</Data><Data Name='ParentProcessName'>C:\Windows\System32\cmd.exe</Data><Data Name='MandatoryLabel'>Mandatory Label\High Mandatory Level</Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Sysmon' Guid='{5770385F-C22A-43E0-BF4C-06F5698FFBD9}'/><EventID>1</EventID><Version>5</Version><Level>4</Level><Task>1</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:39:21.833944500Z'/><EventRecordID>6245420</EventRecordID><Correlation/><Execution ProcessID='2436' ThreadID='2996'/><Channel>Microsoft-Windows-Sysmon/Operational</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security UserID='S-1-5-18'/></System><EventData><Data Name='RuleName'></Data><Data Name='UtcTime'>2021-01-07 15:39:21.793</Data><Data Name='ProcessGuid'>{51E9D293-2B29-5FF7-0000-0010639F0F00}</Data><Data Name='ProcessId'>4964</Data><Data Name='Image'>C:\Windows\System32\certutil.exe</Data><Data Name='FileVersion'>10.0.14393.2097 (rs1_release_1.180212-1105)</Data><Data Name='Description'>CertUtil.exe</Data><Data Name='Product'>Microsoft® Windows® Operating System</Data><Data Name='Company'>Microsoft Corporation</Data><Data Name='OriginalFileName'>CertUtil.exe</Data><Data Name='CommandLine'>certutil.exe  -privatekey -exportpfx  powershellcert.pfx </Data><Data Name='CurrentDirectory'>c:\Users\administrator\Desktop\</Data><Data Name='User'>ATTACKRANGE\Administrator</Data><Data Name='LogonGuid'>{51E9D293-2892-5FF7-0000-002094B30400}</Data><Data Name='LogonId'>0x4b394</Data><Data Name='TerminalSessionId'>1</Data><Data Name='IntegrityLevel'>High</Data><Data Name='Hashes'>MD5=06210E84C1FA61B0A320559DD458625C,SHA256=2818289572EA6B60681D2724737C3E5C87B3731054F47E9D8E4253D8528D88B7,IMPHASH=442218E88D4D6AA0BE3165DD7B20A4C4</Data><Data Name='ParentProcessGuid'>{51E9D293-2A16-5FF7-0000-001040D20B00}</Data><Data Name='ParentProcessId'>5884</Data><Data Name='ParentImage'>C:\Windows\System32\cmd.exe</Data><Data Name='ParentCommandLine'>"C:\Windows\system32\cmd.exe" </Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Security-Auditing' Guid='{54849625-5478-4994-A5BA-3E3B0328C30D}'/><EventID>4688</EventID><Version>2</Version><Level>0</Level><Task>13312</Task><Opcode>0</Opcode><Keywords>0x8020000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:39:04.788137800Z'/><EventRecordID>106488</EventRecordID><Correlation/><Execution ProcessID='4' ThreadID='92'/><Channel>Security</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security/></System><EventData><Data Name='SubjectUserSid'>ATTACKRANGE\Administrator</Data><Data Name='SubjectUserName'>administrator</Data><Data Name='SubjectDomainName'>ATTACKRANGE</Data><Data Name='SubjectLogonId'>0x4b394</Data><Data Name='NewProcessId'>0xb44</Data><Data Name='NewProcessName'>C:\Windows\System32\certutil.exe</Data><Data Name='TokenElevationType'>%%1936</Data><Data Name='ProcessId'>0x16fc</Data><Data Name='CommandLine'>certutil.exe  -privatekey -exportpfx "powershell" powershellcert.pfx </Data><Data Name='TargetUserSid'>NULL SID</Data><Data Name='TargetUserName'>-</Data><Data Name='TargetDomainName'>-</Data><Data Name='TargetLogonId'>0x0</Data><Data Name='ParentProcessName'>C:\Windows\System32\cmd.exe</Data><Data Name='MandatoryLabel'>Mandatory Label\High Mandatory Level</Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Sysmon' Guid='{5770385F-C22A-43E0-BF4C-06F5698FFBD9}'/><EventID>1</EventID><Version>5</Version><Level>4</Level><Task>1</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:39:04.791674600Z'/><EventRecordID>6244677</EventRecordID><Correlation/><Execution ProcessID='2436' ThreadID='2996'/><Channel>Microsoft-Windows-Sysmon/Operational</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security UserID='S-1-5-18'/></System><EventData><Data Name='RuleName'></Data><Data Name='UtcTime'>2021-01-07 15:39:04.788</Data><Data Name='ProcessGuid'>{51E9D293-2B18-5FF7-0000-0010AB7A0F00}</Data><Data Name='ProcessId'>2884</Data><Data Name='Image'>C:\Windows\System32\certutil.exe</Data><Data Name='FileVersion'>10.0.14393.2097 (rs1_release_1.180212-1105)</Data><Data Name='Description'>CertUtil.exe</Data><Data Name='Product'>Microsoft® Windows® Operating System</Data><Data Name='Company'>Microsoft Corporation</Data><Data Name='OriginalFileName'>CertUtil.exe</Data><Data Name='CommandLine'>certutil.exe  -privatekey -exportpfx "powershell" powershellcert.pfx </Data><Data Name='CurrentDirectory'>c:\Users\administrator\Desktop\</Data><Data Name='User'>ATTACKRANGE\Administrator</Data><Data Name='LogonGuid'>{51E9D293-2892-5FF7-0000-002094B30400}</Data><Data Name='LogonId'>0x4b394</Data><Data Name='TerminalSessionId'>1</Data><Data Name='IntegrityLevel'>High</Data><Data Name='Hashes'>MD5=06210E84C1FA61B0A320559DD458625C,SHA256=2818289572EA6B60681D2724737C3E5C87B3731054F47E9D8E4253D8528D88B7,IMPHASH=442218E88D4D6AA0BE3165DD7B20A4C4</Data><Data Name='ParentProcessGuid'>{51E9D293-2A16-5FF7-0000-001040D20B00}</Data><Data Name='ParentProcessId'>5884</Data><Data Name='ParentImage'>C:\Windows\System32\cmd.exe</Data><Data Name='ParentCommandLine'>"C:\Windows\system32\cmd.exe" </Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Sysmon' Guid='{5770385F-C22A-43E0-BF4C-06F5698FFBD9}'/><EventID>1</EventID><Version>5</Version><Level>4</Level><Task>1</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:35:39.051098400Z'/><EventRecordID>6236555</EventRecordID><Correlation/><Execution ProcessID='2436' ThreadID='2996'/><Channel>Microsoft-Windows-Sysmon/Operational</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security UserID='S-1-5-18'/></System><EventData><Data Name='RuleName'></Data><Data Name='UtcTime'>2021-01-07 15:35:38.793</Data><Data Name='ProcessGuid'>{51E9D293-2A4A-5FF7-0000-00106BBD0D00}</Data><Data Name='ProcessId'>5980</Data><Data Name='Image'>C:\Windows\System32\certutil.exe</Data><Data Name='FileVersion'>10.0.14393.2097 (rs1_release_1.180212-1105)</Data><Data Name='Description'>CertUtil.exe</Data><Data Name='Product'>Microsoft® Windows® Operating System</Data><Data Name='Company'>Microsoft Corporation</Data><Data Name='OriginalFileName'>CertUtil.exe</Data><Data Name='CommandLine'>certutil.exe  -exportPFX powershellcert.pfx</Data><Data Name='CurrentDirectory'>c:\Users\administrator\Desktop\</Data><Data Name='User'>ATTACKRANGE\Administrator</Data><Data Name='LogonGuid'>{51E9D293-2892-5FF7-0000-002094B30400}</Data><Data Name='LogonId'>0x4b394</Data><Data Name='TerminalSessionId'>1</Data><Data Name='IntegrityLevel'>High</Data><Data Name='Hashes'>MD5=06210E84C1FA61B0A320559DD458625C,SHA256=2818289572EA6B60681D2724737C3E5C87B3731054F47E9D8E4253D8528D88B7,IMPHASH=442218E88D4D6AA0BE3165DD7B20A4C4</Data><Data Name='ParentProcessGuid'>{51E9D293-2A16-5FF7-0000-001040D20B00}</Data><Data Name='ParentProcessId'>5884</Data><Data Name='ParentImage'>C:\Windows\System32\cmd.exe</Data><Data Name='ParentCommandLine'>"C:\Windows\system32\cmd.exe" </Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Security-Auditing' Guid='{54849625-5478-4994-A5BA-3E3B0328C30D}'/><EventID>4688</EventID><Version>2</Version><Level>0</Level><Task>13312</Task><Opcode>0</Opcode><Keywords>0x8020000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:35:38.793975000Z'/><EventRecordID>106379</EventRecordID><Correlation/><Execution ProcessID='4' ThreadID='2196'/><Channel>Security</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security/></System><EventData><Data Name='SubjectUserSid'>ATTACKRANGE\Administrator</Data><Data Name='SubjectUserName'>administrator</Data><Data Name='SubjectDomainName'>ATTACKRANGE</Data><Data Name='SubjectLogonId'>0x4b394</Data><Data Name='NewProcessId'>0x175c</Data><Data Name='NewProcessName'>C:\Windows\System32\certutil.exe</Data><Data Name='TokenElevationType'>%%1936</Data><Data Name='ProcessId'>0x16fc</Data><Data Name='CommandLine'>certutil.exe  -exportPFX powershellcert.pfx</Data><Data Name='TargetUserSid'>NULL SID</Data><Data Name='TargetUserName'>-</Data><Data Name='TargetDomainName'>-</Data><Data Name='TargetLogonId'>0x0</Data><Data Name='ParentProcessName'>C:\Windows\System32\cmd.exe</Data><Data Name='MandatoryLabel'>Mandatory Label\High Mandatory Level</Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Security-Auditing' Guid='{54849625-5478-4994-A5BA-3E3B0328C30D}'/><EventID>4688</EventID><Version>2</Version><Level>0</Level><Task>13312</Task><Opcode>0</Opcode><Keywords>0x8020000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:12:18.589226900Z'/><EventRecordID>104257</EventRecordID><Correlation/><Execution ProcessID='4' ThreadID='1500'/><Channel>Security</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security/></System><EventData><Data Name='SubjectUserSid'>ATTACKRANGE\Administrator</Data><Data Name='SubjectUserName'>administrator</Data><Data Name='SubjectDomainName'>ATTACKRANGE</Data><Data Name='SubjectLogonId'>0x44d7f</Data><Data Name='NewProcessId'>0x80c</Data><Data Name='NewProcessName'>C:\Windows\System32\notepad.exe</Data><Data Name='TokenElevationType'>%%1936</Data><Data Name='ProcessId'>0x9c8</Data><Data Name='CommandLine'>"C:\Windows\system32\NOTEPAD.EXE" C:\Users\administrator\Desktop\powershellcert.pfx</Data><Data Name='TargetUserSid'>NULL SID</Data><Data Name='TargetUserName'>-</Data><Data Name='TargetDomainName'>-</Data><Data Name='TargetLogonId'>0x0</Data><Data Name='ParentProcessName'>C:\Windows\System32\OpenWith.exe</Data><Data Name='MandatoryLabel'>Mandatory Label\High Mandatory Level</Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Sysmon' Guid='{5770385F-C22A-43E0-BF4C-06F5698FFBD9}'/><EventID>1</EventID><Version>5</Version><Level>4</Level><Task>1</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:12:18.592593300Z'/><EventRecordID>6000335</EventRecordID><Correlation/><Execution ProcessID='2376' ThreadID='2948'/><Channel>Microsoft-Windows-Sysmon/Operational</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security UserID='S-1-5-18'/></System><EventData><Data Name='RuleName'></Data><Data Name='UtcTime'>2021-01-07 15:12:18.589</Data><Data Name='ProcessGuid'>{51E9D293-24D2-5FF7-0000-00107B2B8D00}</Data><Data Name='ProcessId'>2060</Data><Data Name='Image'>C:\Windows\System32\notepad.exe</Data><Data Name='FileVersion'>10.0.14393.0 (rs1_release.160715-1616)</Data><Data Name='Description'>Notepad</Data><Data Name='Product'>Microsoft® Windows® Operating System</Data><Data Name='Company'>Microsoft Corporation</Data><Data Name='OriginalFileName'>NOTEPAD.EXE</Data><Data Name='CommandLine'>"C:\Windows\system32\NOTEPAD.EXE" C:\Users\administrator\Desktop\powershellcert.pfx</Data><Data Name='CurrentDirectory'>C:\Windows\system32\</Data><Data Name='User'>ATTACKRANGE\Administrator</Data><Data Name='LogonGuid'>{51E9D293-44C7-5FF6-0000-00207F4D0400}</Data><Data Name='LogonId'>0x44d7f</Data><Data Name='TerminalSessionId'>1</Data><Data Name='IntegrityLevel'>High</Data><Data Name='Hashes'>MD5=3B508CAE5DEBCBA928B5BC355517E2E6,SHA256=DA0ACEE8F60A460CFB5249E262D3D53211EBC4C777579E99C8202B761541110A,IMPHASH=968239BE2020F1C0DAFFDCDBD49E9C82</Data><Data Name='ParentProcessGuid'>{51E9D293-24CE-5FF7-0000-00102E088D00}</Data><Data Name='ParentProcessId'>2504</Data><Data Name='ParentImage'>C:\Windows\System32\OpenWith.exe</Data><Data Name='ParentCommandLine'>C:\Windows\system32\OpenWith.exe -Embedding</Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Security-Auditing' Guid='{54849625-5478-4994-A5BA-3E3B0328C30D}'/><EventID>4688</EventID><Version>2</Version><Level>0</Level><Task>13312</Task><Opcode>0</Opcode><Keywords>0x8020000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:12:04.877337600Z'/><EventRecordID>104255</EventRecordID><Correlation/><Execution ProcessID='4' ThreadID='1844'/><Channel>Security</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security/></System><EventData><Data Name='SubjectUserSid'>ATTACKRANGE\Administrator</Data><Data Name='SubjectUserName'>administrator</Data><Data Name='SubjectDomainName'>ATTACKRANGE</Data><Data Name='SubjectLogonId'>0x44d7f</Data><Data Name='NewProcessId'>0x1104</Data><Data Name='NewProcessName'>C:\Windows\System32\rundll32.exe</Data><Data Name='TokenElevationType'>%%1936</Data><Data Name='ProcessId'>0xffc</Data><Data Name='CommandLine'>"C:\Windows\system32\rundll32.exe" cryptext.dll,CryptExtAddPFX C:\Users\administrator\Desktop\powershellcert.pfx</Data><Data Name='TargetUserSid'>NULL SID</Data><Data Name='TargetUserName'>-</Data><Data Name='TargetDomainName'>-</Data><Data Name='TargetLogonId'>0x0</Data><Data Name='ParentProcessName'>C:\Windows\explorer.exe</Data><Data Name='MandatoryLabel'>Mandatory Label\High Mandatory Level</Data></EventData></Event>
<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Sysmon' Guid='{5770385F-C22A-43E0-BF4C-06F5698FFBD9}'/><EventID>1</EventID><Version>5</Version><Level>4</Level><Task>1</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime='2021-01-07T15:12:04.880266100Z'/><EventRecordID>5999763</EventRecordID><Correlation/><Execution ProcessID='2376' ThreadID='2948'/><Channel>Microsoft-Windows-Sysmon/Operational</Channel><Computer>win-dc-791937.attackrange.local</Computer><Security UserID='S-1-5-18'/></System><EventData><Data Name='RuleName'></Data><Data Name='UtcTime'>2021-01-07 15:12:04.877</Data><Data Name='ProcessGuid'>{51E9D293-24C4-5FF7-0000-0010F3D78C00}</Data><Data Name='ProcessId'>4356</Data><Data Name='Image'>C:\Windows\System32\rundll32.exe</Data><Data Name='FileVersion'>10.0.14393.0 (rs1_release.160715-1616)</Data><Data Name='Description'>Windows host process (Rundll32)</Data><Data Name='Product'>Microsoft® Windows® Operating System</Data><Data Name='Company'>Microsoft Corporation</Data><Data Name='OriginalFileName'>RUNDLL32.EXE</Data><Data Name='CommandLine'>"C:\Windows\system32\rundll32.exe" cryptext.dll,CryptExtAddPFX C:\Users\administrator\Desktop\powershellcert.pfx</Data><Data Name='CurrentDirectory'>C:\Users\administrator\Desktop\</Data><Data Name='User'>ATTACKRANGE\Administrator</Data><Data Name='LogonGuid'>{51E9D293-44C7-5FF6-0000-00207F4D0400}</Data><Data Name='LogonId'>0x44d7f</Data><Data Name='TerminalSessionId'>1</Data><Data Name='IntegrityLevel'>High</Data><Data Name='Hashes'>MD5=C7645D43451C6D94D87F4D07BDE59C89,SHA256=495BBA47FC43EE23054FCD419F2F00457162D1C04296900C6AEA551102A810F3,IMPHASH=7D1CE1BAFE48B63D9D19E8E0E5DF3E6C</Data><Data Name='ParentProcessGuid'>{51E9D293-44CA-5FF6-0000-0010E9940400}</Data><Data Name='ParentProcessId'>4092</Data><Data Name='ParentImage'>C:\Windows\explorer.exe</Data><Data Name='ParentCommandLine'>C:\Windows\Explorer.EXE /NOUACCHECK</Data></EventData></Event>
01/06/2021 10:49:16 PM
LogName=Microsoft-Windows-PowerShell/Operational
SourceName=Microsoft-Windows-PowerShell
EventCode=4104
EventType=5
Type=Verbose
ComputerName=win-dc-791937.attackrange.local
User=NOT_TRANSLATED
Sid=S-1-5-21-4072314881-2634547730-233802997-500
SidType=0
TaskCategory=Execute a Remote Command
OpCode=On create calls
RecordNumber=59074
Keywords=None
Message=Creating Scriptblock text (1 of 1):
Export-PfxCertificate -cert $path -FilePath c:\Users\administrator\Desktop\powershellcert.pfx -Password Password1

ScriptBlock ID: 7219ff69-aec2-4287-a149-a3ef12964f32
Path:
01/06/2021 10:49:16 PM
LogName=Microsoft-Windows-PowerShell/Operational
SourceName=Microsoft-Windows-PowerShell
EventCode=4104
EventType=5
Type=Verbose
ComputerName=win-dc-791937.attackrange.local
User=NOT_TRANSLATED
Sid=S-1-5-21-4072314881-2634547730-233802997-500
SidType=0
TaskCategory=Execute a Remote Command
OpCode=On create calls
RecordNumber=59074
Keywords=None
Message=Creating Scriptblock text (1 of 1):
Export-PfxCertificate -cert $path -FilePath c:\Users\administrator\Desktop\powershellcert.pfx -Password Password1

ScriptBlock ID: 7219ff69-aec2-4287-a149-a3ef12964f32
Path:
01/06/2021 10:49:04 PM
LogName=Microsoft-Windows-PowerShell/Operational
SourceName=Microsoft-Windows-PowerShell
EventCode=4104
EventType=5
Type=Verbose
ComputerName=win-dc-791937.attackrange.local
User=NOT_TRANSLATED
Sid=S-1-5-21-4072314881-2634547730-233802997-500
SidType=0
TaskCategory=Execute a Remote Command
OpCode=On create calls
RecordNumber=58924
Keywords=None
Message=Creating Scriptblock text (1 of 1):
Export-PfxCertificate -cert $path -FilePath c:\Users\administrator\Desktop\powershellcert.pfx 

ScriptBlock ID: 9982cf52-c608-4ad0-adb1-618169d26515
Path:
01/06/2021 10:49:04 PM
LogName=Microsoft-Windows-PowerShell/Operational
SourceName=Microsoft-Windows-PowerShell
EventCode=4104
EventType=5
Type=Verbose
ComputerName=win-dc-791937.attackrange.local
User=NOT_TRANSLATED
Sid=S-1-5-21-4072314881-2634547730-233802997-500
SidType=0
TaskCategory=Execute a Remote Command
OpCode=On create calls
RecordNumber=58924
Keywords=None
Message=Creating Scriptblock text (1 of 1):
Export-PfxCertificate -cert $path -FilePath c:\Users\administrator\Desktop\powershellcert.pfx 

ScriptBlock ID: 9982cf52-c608-4ad0-adb1-618169d26515
Path:
01/06/2021 10:47:51 PM
LogName=Microsoft-Windows-PowerShell/Operational
SourceName=Microsoft-Windows-PowerShell
EventCode=4104
EventType=5
Type=Verbose
ComputerName=win-dc-791937.attackrange.local
User=NOT_TRANSLATED
Sid=S-1-5-21-4072314881-2634547730-233802997-500
SidType=0
TaskCategory=Execute a Remote Command
OpCode=On create calls
RecordNumber=58697
Keywords=None
Message=Creating Scriptblock text (1 of 1):
Export-PfxCertificate -cert $path -FilePath c:\Users\administrator\Desktop\powershellcert.pfx -Password Password1

ScriptBlock ID: d61ab102-d0b0-4a5e-853b-d9a08d2e10cd
Path:
01/06/2021 10:47:51 PM
LogName=Microsoft-Windows-PowerShell/Operational
SourceName=Microsoft-Windows-PowerShell
EventCode=4104
EventType=5
Type=Verbose
ComputerName=win-dc-791937.attackrange.local
User=NOT_TRANSLATED
Sid=S-1-5-21-4072314881-2634547730-233802997-500
SidType=0
TaskCategory=Execute a Remote Command
OpCode=On create calls
RecordNumber=58697
Keywords=None
Message=Creating Scriptblock text (1 of 1):
Export-PfxCertificate -cert $path -FilePath c:\Users\administrator\Desktop\powershellcert.pfx -Password Password1

ScriptBlock ID: d61ab102-d0b0-4a5e-853b-d9a08d2e10cd
Path:
01/06/2021 10:47:31 PM
LogName=Microsoft-Windows-PowerShell/Operational
SourceName=Microsoft-Windows-PowerShell
EventCode=4104
EventType=5
Type=Verbose
ComputerName=win-dc-791937.attackrange.local
User=NOT_TRANSLATED
Sid=S-1-5-21-4072314881-2634547730-233802997-500
SidType=0
TaskCategory=Execute a Remote Command
OpCode=On create calls
RecordNumber=58632
Keywords=None
Message=Creating Scriptblock text (1 of 1):
Export-PfxCertificate -cert $path -FilePath c:\Users\administrator\Desktop\powershellcert.pfx -Password 1234

ScriptBlock ID: 88a162ea-01bb-465d-a4ba-48e5ae05d8e5
Path:
01/06/2021 10:47:31 PM
LogName=Microsoft-Windows-PowerShell/Operational
SourceName=Microsoft-Windows-PowerShell
EventCode=4104
EventType=5
Type=Verbose
ComputerName=win-dc-791937.attackrange.local
User=NOT_TRANSLATED
Sid=S-1-5-21-4072314881-2634547730-233802997-500
SidType=0
TaskCategory=Execute a Remote Command
OpCode=On create calls
RecordNumber=58632
Keywords=None
Message=Creating Scriptblock text (1 of 1):
Export-PfxCertificate -cert $path -FilePath c:\Users\administrator\Desktop\powershellcert.pfx -Password 1234

ScriptBlock ID: 88a162ea-01bb-465d-a4ba-48e5ae05d8e5
Path:
01/06/2021 10:44:49 PM
LogName=Microsoft-Windows-PowerShell/Operational
SourceName=Microsoft-Windows-PowerShell
EventCode=4104
EventType=5
Type=Verbose
ComputerName=win-dc-791937.attackrange.local
User=NOT_TRANSLATED
Sid=S-1-5-21-4072314881-2634547730-233802997-500
SidType=0
TaskCategory=Execute a Remote Command
OpCode=On create calls
RecordNumber=58491
Keywords=None
Message=Creating Scriptblock text (1 of 1):
Export-PfxCertificate -cert $path -FilePath c:\Users\administrator\Desktop\powershellcert.pfx -Password $pwd

ScriptBlock ID: 25efb511-64e3-4df8-8d41-0f584c504713
Path:
01/06/2021 10:44:49 PM
LogName=Microsoft-Windows-PowerShell/Operational
SourceName=Microsoft-Windows-PowerShell
EventCode=4104
EventType=5
Type=Verbose
ComputerName=win-dc-791937.attackrange.local
User=NOT_TRANSLATED
Sid=S-1-5-21-4072314881-2634547730-233802997-500
SidType=0
TaskCategory=Execute a Remote Command
OpCode=On create calls
RecordNumber=58491
Keywords=None
Message=Creating Scriptblock text (1 of 1):
Export-PfxCertificate -cert $path -FilePath c:\Users\administrator\Desktop\powershellcert.pfx -Password $pwd

ScriptBlock ID: 25efb511-64e3-4df8-8d41-0f584c504713
Path:
01/06/2021 10:44:26 PM
LogName=Microsoft-Windows-PowerShell/Operational
SourceName=Microsoft-Windows-PowerShell
EventCode=4104
EventType=5
Type=Verbose
ComputerName=win-dc-791937.attackrange.local
User=NOT_TRANSLATED
Sid=S-1-5-21-4072314881-2634547730-233802997-500
SidType=0
TaskCategory=Execute a Remote Command
OpCode=On create calls
RecordNumber=58462
Keywords=None
Message=Creating Scriptblock text (1 of 1):
c:\Users\administrator\Desktop\powershellcert.pfx -Password $pwd

ScriptBlock ID: 0d04a46d-423c-466e-8962-eff95116c6a4
Path:
01/06/2021 10:44:26 PM
LogName=Microsoft-Windows-PowerShell/Operational
SourceName=Microsoft-Windows-PowerShell
EventCode=4104
EventType=5
Type=Verbose
ComputerName=win-dc-791937.attackrange.local
User=NOT_TRANSLATED
Sid=S-1-5-21-4072314881-2634547730-233802997-500
SidType=0
TaskCategory=Execute a Remote Command
OpCode=On create calls
RecordNumber=58462
Keywords=None
Message=Creating Scriptblock text (1 of 1):
c:\Users\administrator\Desktop\powershellcert.pfx -Password $pwd

ScriptBlock ID: 0d04a46d-423c-466e-8962-eff95116c6a4
Path:
01/06/2021 10:43:21 PM
LogName=Microsoft-Windows-PowerShell/Operational
SourceName=Microsoft-Windows-PowerShell
EventCode=4104
EventType=5
Type=Verbose
ComputerName=win-dc-791937.attackrange.local
User=NOT_TRANSLATED
Sid=S-1-5-21-4072314881-2634547730-233802997-500
SidType=0
TaskCategory=Execute a Remote Command
OpCode=On create calls
RecordNumber=58432
Keywords=None
Message=Creating Scriptblock text (1 of 1):
c:\Users\administrator\Desktop\powershellcert.pfx -Password $pwd

ScriptBlock ID: 6a68bece-027e-4fc1-bead-c4bbf121a301
Path:
01/06/2021 10:43:21 PM
LogName=Microsoft-Windows-PowerShell/Operational
SourceName=Microsoft-Windows-PowerShell
EventCode=4104
EventType=5
Type=Verbose
ComputerName=win-dc-791937.attackrange.local
User=NOT_TRANSLATED
Sid=S-1-5-21-4072314881-2634547730-233802997-500
SidType=0
TaskCategory=Execute a Remote Command
OpCode=On create calls
RecordNumber=58432
Keywords=None
Message=Creating Scriptblock text (1 of 1):
c:\Users\administrator\Desktop\powershellcert.pfx -Password $pwd

ScriptBlock ID: 6a68bece-027e-4fc1-bead-c4bbf121a301
Path:
01/04/2021 09:40:20 PM
LogName=Microsoft-Windows-PowerShell/Operational
SourceName=Microsoft-Windows-PowerShell
EventCode=4104
EventType=3
Type=Warning
ComputerName=win-client-5873806
User=NOT_TRANSLATED
Sid=S-1-5-21-1854396824-2342670854-3736740652-1000
SidType=0
TaskCategory=Execute a Remote Command
OpCode=On create calls
RecordNumber=10379
Keywords=None
Message=Creating Scriptblock text (1 of 1):
# Copyright (c) 2019 Ansible Project
# Simplified BSD License (see licenses/simplified_bsd.txt or https://opensource.org/licenses/BSD-2-Clause)

Function Get-AnsibleWebRequest {
    <#
    .SYNOPSIS
    Creates a System.Net.WebRequest object based on common URL module options in Ansible.

    .DESCRIPTION
    Will create a WebRequest based on common input options within Ansible. This can be used manually or with
    Invoke-WithWebRequest.

    .PARAMETER Uri
    The URI to create the web request for.

    .PARAMETER Method
    The protocol method to use, if omitted, will use the default value for the URI protocol specified.

    .PARAMETER FollowRedirects
    Whether to follow redirect reponses. This is only valid when using a HTTP URI.
        all - Will follow all redirects
        none - Will follow no redirects
        safe - Will only follow redirects when GET or HEAD is used as the Method

    .PARAMETER Headers
    A hashtable or dictionary of header values to set on the request. This is only valid for a HTTP URI.

    .PARAMETER HttpAgent
    A string to set for the 'User-Agent' header. This is only valid for a HTTP URI.

    .PARAMETER MaximumRedirection
    The maximum number of redirections that will be followed. This is only valid for a HTTP URI.

    .PARAMETER Timeout
    The timeout in seconds that defines how long to wait until the request times out.

    .PARAMETER ValidateCerts
    Whether to validate SSL certificates, default to True.

    .PARAMETER ClientCert
    The path to PFX file to use for X509 authentication. This is only valid for a HTTP URI. This path can either
    be a filesystem path (C:\folder\cert.pfx) or a PSPath to a credential (Cert:\CurrentUser\My\<thumbprint>).

    .PARAMETER ClientCertPassword
    The password for the PFX certificate if required. This is only valid for a HTTP URI.

    .PARAMETER ForceBasicAuth
    Whether to set the Basic auth header on the first request instead of when required. This is only valid for a
    HTTP URI.

    .PARAMETER UrlUsername
    The username to use for authenticating with the target.

    .PARAMETER UrlPassword
    The password to use for authenticating with the target.

    .PARAMETER UseDefaultCredential
    Whether to use the current user's credentials if available. This will only work when using Become, using SSH with
    password auth, or WinRM with CredSSP or Kerberos with credential delegation.

    .PARAMETER UseProxy
    Whether to use the default proxy defined in IE (WinINet) for the user or set no proxy at all. This should not
    be set to True when ProxyUrl is also defined.

    .PARAMETER ProxyUrl
    An explicit proxy server to use for the request instead of relying on the default proxy in IE. This is only
    valid for a HTTP URI.

    .PARAMETER ProxyUsername
    An optional username to use for proxy authentication.

    .PARAMETER ProxyPassword
    The password for ProxyUsername.

    .PARAMETER ProxyUseDefaultCredential
    Whether to use the current user's credentials for proxy authentication if available. This will only work when
    using Become, using SSH with password auth, or WinRM with CredSSP or Kerberos with credential delegation.

    .PARAMETER Module
    The AnsibleBasic module that can be used as a backup parameter source or a way to return warnings back to the
    Ansible controller.

    .EXAMPLE
    $spec = @{
        options = @{}
    }
    $spec.options += $ansible_web_request_options
    $module = Ansible.Basic.AnsibleModule]::Create($args, $spec)

    $web_request = Get-AnsibleWebRequest -Module $module
    #>
    [CmdletBinding()]
    [OutputType([System.Net.WebRequest])]
    Param (
        [Alias("url")]
        [System.Uri]
        $Uri,

        [System.String]
        $Method,

        [Alias("follow_redirects")]
        [ValidateSet("all", "none", "safe")]
        [System.String]
        $FollowRedirects = "safe",

        [System.Collections.IDictionary]
        $Headers,

        [Alias("http_agent")]
        [System.String]
        $HttpAgent = "ansible-httpget",

        [Alias("maximum_redirection")]
        [System.Int32]
        $MaximumRedirection = 50,

        [System.Int32]
        $Timeout = 30,

        [Alias("validate_certs")]
        [System.Boolean]
        $ValidateCerts = $true,

        # Credential params
        [Alias("client_cert")]
        [System.String]
        $ClientCert,

        [Alias("client_cert_password")]
        [System.String]
        $ClientCertPassword,

        [Alias("force_basic_auth")]
        [Switch]
        $ForceBasicAuth,

        [Alias("url_username")]
        [System.String]
        $UrlUsername,

        [Alias("url_password")]
        [System.String]
        $UrlPassword,

        [Alias("use_default_credential")]
        [Switch]
        $UseDefaultCredential,

        # Proxy params
        [Alias("use_proxy")]
        [System.Boolean]
        $UseProxy = $true,

        [Alias("proxy_url")]
        [System.String]
        $ProxyUrl,

        [Alias("proxy_username")]
        [System.String]
        $ProxyUsername,

        [Alias("proxy_password")]
        [System.String]
        $ProxyPassword,

        [Alias("proxy_use_default_credential")]
        [Switch]
        $ProxyUseDefaultCredential,

        [ValidateScript({ $_.GetType().FullName -eq 'Ansible.Basic.AnsibleModule' })]
        [System.Object]
        $Module
    )

    # Set module options for parameters unless they were explicitly passed in.
    if ($Module) {
        foreach ($param in $PSCmdlet.MyInvocation.MyCommand.Parameters.GetEnumerator()) {
            if ($PSBoundParameters.ContainsKey($param.Key)) {
                # Was set explicitly we want to use that value
                continue
            }

            foreach ($alias in @($Param.Key) + $param.Value.Aliases) {
                if ($Module.Params.ContainsKey($alias)) {
                    $var_value = $Module.Params.$alias -as $param.Value.ParameterType
                    Set-Variable -Name $param.Key -Value $var_value
                    break
                }
            }
        }
    }

    # Disable certificate validation if requested
    # FUTURE: set this on ServerCertificateValidationCallback of the HttpWebRequest once .NET 4.5 is the minimum
    if (-not $ValidateCerts) {
        [System.Net.ServicePointManager]::ServerCertificateValidationCallback = { $true }
    }

    # Enable TLS1.1/TLS1.2 if they're available but disabled (eg. .NET 4.5)
    $security_protocols = [System.Net.ServicePointManager]::SecurityProtocol -bor [System.Net.SecurityProtocolType]::SystemDefault
    if ([System.Net.SecurityProtocolType].GetMember("Tls11").Count -gt 0) {
        $security_protocols = $security_protocols -bor [System.Net.SecurityProtocolType]::Tls11
    }
    if ([System.Net.SecurityProtocolType].GetMember("Tls12").Count -gt 0) {
        $security_protocols = $security_protocols -bor [System.Net.SecurityProtocolType]::Tls12
    }
    [System.Net.ServicePointManager]::SecurityProtocol = $security_protocols

    $web_request = [System.Net.WebRequest]::Create($Uri)
    if ($Method) {
        $web_request.Method = $Method
    }
    $web_request.Timeout = $Timeout * 1000

    if ($UseDefaultCredential -and $web_request -is [System.Net.HttpWebRequest]) {
        $web_request.UseDefaultCredentials = $true
    } elseif ($UrlUsername) {
        if ($ForceBasicAuth) {
            $auth_value = [System.Convert]::ToBase64String([System.Text.Encoding]::ASCII.GetBytes(("{0}:{1}" -f $UrlUsername, $UrlPassword)))
            $web_request.Headers.Add("Authorization", "Basic $auth_value")
        } else {
            $credential = New-Object -TypeName System.Net.NetworkCredential -ArgumentList $UrlUsername, $UrlPassword
            $web_request.Credentials = $credential
        }
    }

    if ($ClientCert) {
        # Expecting either a filepath or PSPath (Cert:\CurrentUser\My\<thumbprint>)
        $cert = Get-Item -LiteralPath $ClientCert -ErrorAction SilentlyContinue
        if ($null -eq $cert) {
            Write-Error -Message "Client certificate '$ClientCert' does not exist" -Category ObjectNotFound
            return
        }

        $crypto_ns = 'System.Security.Cryptography.X509Certificates'
        if ($cert.PSProvider.Name -ne 'Certificate') {
            try {
                $cert = New-Object -TypeName "$crypto_ns.X509Certificate2" -ArgumentList @(
                    $ClientCert, $ClientCertPassword
                )
            } catch [System.Security.Cryptography.CryptographicException] {
                Write-Error -Message "Failed to read client certificate at '$ClientCert'" -Exception $_.Exception -Category SecurityError
                return
            }
        }
        $web_request.ClientCertificates = New-Object -TypeName "$crypto_ns.X509Certificate2Collection" -ArgumentList @(
            $cert
        )
    }

    if (-not $UseProxy) {
        $proxy = $null
    } elseif ($ProxyUrl) {
        $proxy = New-Object -TypeName System.Net.WebProxy -ArgumentList $ProxyUrl, $true
    } else  {
        $proxy = $web_request.Proxy
    }

    # $web_request.Proxy may return $null for a FTP web request. We only set the credentials if we have an actual
    # proxy to work with, otherwise just ignore the credentials property.
    if ($null -ne $proxy) {
        if ($ProxyUseDefaultCredential) {
            # Weird hack, $web_request.Proxy returns an IWebProxy object which only gurantees the Credentials
            # property. We cannot set UseDefaultCredentials so we just set the Credentials to the
            # DefaultCredentials in the CredentialCache which does the same thing.
            $proxy.Credentials = [System.Net.CredentialCache]::DefaultCredentials
        } elseif ($ProxyUsername) {
            $proxy.Credentials = New-Object -TypeName System.Net.NetworkCredential -ArgumentList @(
                $ProxyUsername, $ProxyPassword
            )
        } else {
            $proxy.Credentials = $null
        }

        $web_request.Proxy = $proxy
    }

    # Some parameters only apply when dealing with a HttpWebRequest
    if ($web_request -is [System.Net.HttpWebRequest]) {
        if ($Headers) {
            foreach ($header in $Headers.GetEnumerator()) {
                switch ($header.Key) {
                    Accept { $web_request.Accept = $header.Value }
                    Connection { $web_request.Connection = $header.Value }
                    Content-Length { $web_request.ContentLength = $header.Value }
                    Content-Type { $web_request.ContentType = $header.Value }
                    Expect { $web_request.Expect = $header.Value }
                    Date { $web_request.Date = $header.Value }
                    Host { $web_request.Host = $header.Value }
                    If-Modified-Since { $web_request.IfModifiedSince = $header.Value }
                    Range { $web_request.AddRange($header.Value) }
                    Referer { $web_request.Referer = $header.Value }
                    Transfer-Encoding {
                        $web_request.SendChunked = $true
                        $web_request.TransferEncoding = $header.Value
                    }
                    User-Agent { continue }
                    default { $web_request.Headers.Add($header.Key, $header.Value) }
                }
            }
        }

        # For backwards compatibility we need to support setting the User-Agent if the header was set in the task.
        # We just need to make sure that if an explicit http_agent module was set then that takes priority.
        if ($Headers -and $Headers.ContainsKey("User-Agent")) {
            if ($HttpAgent -eq $ansible_web_request_options.http_agent.default) {
                $HttpAgent = $Headers['User-Agent']
            } elseif ($null -ne $Module) {
                $Module.Warn("The 'User-Agent' header and the 'http_agent' was set, using the 'http_agent' for web request")
            }
        }
        $web_request.UserAgent = $HttpAgent

        switch ($FollowRedirects) {
            none { $web_request.AllowAutoRedirect = $false }
            safe {
                if ($web_request.Method -in @("GET", "HEAD")) {
                    $web_request.AllowAutoRedirect = $false
                } else {
                    $web_request.AllowAutoRedirect = $true
                }
            }
            all { $web_request.AllowAutoRedirect = $true }
        }

        if ($MaximumRedirection -eq 0) {
            $web_request.AllowAutoRedirect = $false
        } else {
            $web_request.MaximumAutomaticRedirections = $MaximumRedirection
        }
    }

    return $web_request
}

Function Invoke-WithWebRequest {
    <#
    .SYNOPSIS
    Invokes a ScriptBlock with the WebRequest.

    .DESCRIPTION
    Invokes the ScriptBlock and handle extra information like accessing the response stream, closing those streams
    safely as well as setting common module return values.

    .PARAMETER Module
    The Ansible.Basic module to set the return values for. This will set the following return values;
        elapsed - The total time, in seconds, that it took to send the web request and process the response
        msg - The human readable description of the response status code
        status_code - An int that is the response status code

    .PARAMETER Request
    The System.Net.WebRequest to call. This can either be manually crafted or created with Get-AnsibleWebRequest.

    .PARAMETER Script
    The ScriptBlock to invoke during the web request. This ScriptBlock should take in the params
        Param ([System.Net.WebResponse]$Response, [System.IO.Stream]$Stream)

    This scriptblock should manage the response based on what it need to do.

    .PARAMETER Body
    An optional Stream to send to the target during the request.

    .PARAMETER IgnoreBadResponse
    By default a WebException will be raised for a non 2xx status code and the Script will not be invoked. This
    parameter can be set to process all responses regardless of the status code.

    .EXAMPLE Basic module that downloads a file
    $spec = @{
        options = @{
            path = @{ type = "path"; required = $true }
        }
    }
    $spec.options += $ansible_web_request_options
    $module = Ansible.Basic.AnsibleModule]::Create($args, $spec)

    $web_request = Get-AnsibleWebRequest -Module $module

    Invoke-WithWebRequest -Module $module -Request $web_request -Script {
        Param ([System.Net.WebResponse]$Response, [System.IO.Stream]$Stream)

        $fs = [System.IO.File]::Create($module.Params.path)
        try {
            $Stream.CopyTo($fs)
            $fs.Flush()
        } finally {
            $fs.Dispose()
        }
    }
    #>
    [CmdletBinding()]
    param (
        [Parameter(Mandatory=$true)]
        [System.Object]
        [ValidateScript({ $_.GetType().FullName -eq 'Ansible.Basic.AnsibleModule' })]
        $Module,

        [Parameter(Mandatory=$true)]
        [System.Net.WebRequest]
        $Request,

        [Parameter(Mandatory=$true)]
        [ScriptBlock]
        $Script,

        [AllowNull()]
        [System.IO.Stream]
        $Body,

        [Switch]
        $IgnoreBadResponse
    )

    $start = Get-Date
    if ($null -ne $Body) {
        $request_st = $Request.GetRequestStream()
        try {
            $Body.CopyTo($request_st)
            $request_st.Flush()
        } finally {
            $request_st.Close()
        }
    }

    try {
        try {
            $web_response = $Request.GetResponse()
        } catch [System.Net.WebException] {
            # A WebResponse with a status code not in the 200 range will raise a WebException. We check if the
            # exception raised contains the actual response and continue on if IgnoreBadResponse is set. We also
            # make sure we set the status_code return value on the Module object if possible

            if ($_.Exception.PSObject.Properties.Name -match "Response") {
                $web_response = $_.Exception.Response

                if (-not $IgnoreBadResponse -or $null -eq $web_response) {
                    $Module.Result.msg = $_.Exception.StatusDescription
                    $Module.Result.status_code = $_.Exception.Response.StatusCode
                    throw $_
                }
            } else {
                throw $_
            }
        }

        if ($Request.RequestUri.IsFile) {
            # A FileWebResponse won't have these properties set
            $Module.Result.msg = "OK"
            $Module.Result.status_code = 200
        } else {
            $Module.Result.msg = $web_response.StatusDescription
            $Module.Result.status_code = $web_response.StatusCode
        }

        $response_stream = $web_response.GetResponseStream()
        try {
            # Invoke the ScriptBlock and pass in WebResponse and ResponseStream
            &$Script -Response $web_response -Stream $response_stream
        } finally {
            $response_stream.Dispose()
        }
    } finally {
        if ($web_response) {
            $web_response.Close()
        }
        $Module.Result.elapsed = ((Get-date) - $start).TotalSeconds
    }
}

$ansible_web_request_options = @{
    url = @{ type="str"; required=$true }
    method = @{ type="str" }
    follow_redirects = @{ type="str"; choices=@("all","none","safe"); default="safe" }
    headers = @{ type="dict" }
    http_agent = @{ type="str"; default="ansible-httpget" }
    maximum_redirection = @{ type="int"; default=50 }
    timeout = @{ type="int"; default=30 }  # Was defaulted to 10 in win_get_url but 30 in win_uri so we use 30
    validate_certs = @{ type="bool"; default=$true }

    # Credential options
    client_cert = @{ type="str" }
    client_cert_password = @{ type="str"; no_log=$true }
    force_basic_auth = @{ type="bool"; default=$false }
    url_username = @{ type="str"; aliases=@("user", "username") }  # user was used in win_uri
    url_password = @{ type="str"; aliases=@("password"); no_log=$true }
    use_default_credential = @{ type="bool"; default=$false }

    # Proxy options
    use_proxy = @{ type="bool"; default=$true }
    proxy_url = @{ type="str" }
    proxy_username = @{ type="str" }
    proxy_password = @{ type="str"; no_log=$true }
    proxy_use_default_credential = @{ type="bool"; default=$false }
}

$export_members = @{
    Function = "Get-AnsibleWebRequest", "Invoke-WithWebRequest"
    Variable = "ansible_web_request_options"
}
Export-ModuleMember @export_members


ScriptBlock ID: ba31bcf1-7806-46df-aa2b-55bac4ab3c17
Path:
01/04/2021 09:31:33 PM
LogName=Microsoft-Windows-PowerShell/Operational
SourceName=Microsoft-Windows-PowerShell
EventCode=4104
EventType=3
Type=Warning
ComputerName=win-dc-791937.attackrange.local
User=NOT_TRANSLATED
Sid=S-1-5-21-4072314881-2634547730-233802997-1000
SidType=0
TaskCategory=Execute a Remote Command
OpCode=On create calls
RecordNumber=11869
Keywords=None
Message=Creating Scriptblock text (1 of 1):
# Copyright (c) 2019 Ansible Project
# Simplified BSD License (see licenses/simplified_bsd.txt or https://opensource.org/licenses/BSD-2-Clause)

Function Get-AnsibleWebRequest {
    <#
    .SYNOPSIS
    Creates a System.Net.WebRequest object based on common URL module options in Ansible.

    .DESCRIPTION
    Will create a WebRequest based on common input options within Ansible. This can be used manually or with
    Invoke-WithWebRequest.

    .PARAMETER Uri
    The URI to create the web request for.

    .PARAMETER Method
    The protocol method to use, if omitted, will use the default value for the URI protocol specified.

    .PARAMETER FollowRedirects
    Whether to follow redirect reponses. This is only valid when using a HTTP URI.
        all - Will follow all redirects
        none - Will follow no redirects
        safe - Will only follow redirects when GET or HEAD is used as the Method

    .PARAMETER Headers
    A hashtable or dictionary of header values to set on the request. This is only valid for a HTTP URI.

    .PARAMETER HttpAgent
    A string to set for the 'User-Agent' header. This is only valid for a HTTP URI.

    .PARAMETER MaximumRedirection
    The maximum number of redirections that will be followed. This is only valid for a HTTP URI.

    .PARAMETER Timeout
    The timeout in seconds that defines how long to wait until the request times out.

    .PARAMETER ValidateCerts
    Whether to validate SSL certificates, default to True.

    .PARAMETER ClientCert
    The path to PFX file to use for X509 authentication. This is only valid for a HTTP URI. This path can either
    be a filesystem path (C:\folder\cert.pfx) or a PSPath to a credential (Cert:\CurrentUser\My\<thumbprint>).

    .PARAMETER ClientCertPassword
    The password for the PFX certificate if required. This is only valid for a HTTP URI.

    .PARAMETER ForceBasicAuth
    Whether to set the Basic auth header on the first request instead of when required. This is only valid for a
    HTTP URI.

    .PARAMETER UrlUsername
    The username to use for authenticating with the target.

    .PARAMETER UrlPassword
    The password to use for authenticating with the target.

    .PARAMETER UseDefaultCredential
    Whether to use the current user's credentials if available. This will only work when using Become, using SSH with
    password auth, or WinRM with CredSSP or Kerberos with credential delegation.

    .PARAMETER UseProxy
    Whether to use the default proxy defined in IE (WinINet) for the user or set no proxy at all. This should not
    be set to True when ProxyUrl is also defined.

    .PARAMETER ProxyUrl
    An explicit proxy server to use for the request instead of relying on the default proxy in IE. This is only
    valid for a HTTP URI.

    .PARAMETER ProxyUsername
    An optional username to use for proxy authentication.

    .PARAMETER ProxyPassword
    The password for ProxyUsername.

    .PARAMETER ProxyUseDefaultCredential
    Whether to use the current user's credentials for proxy authentication if available. This will only work when
    using Become, using SSH with password auth, or WinRM with CredSSP or Kerberos with credential delegation.

    .PARAMETER Module
    The AnsibleBasic module that can be used as a backup parameter source or a way to return warnings back to the
    Ansible controller.

    .EXAMPLE
    $spec = @{
        options = @{}
    }
    $spec.options += $ansible_web_request_options
    $module = Ansible.Basic.AnsibleModule]::Create($args, $spec)

    $web_request = Get-AnsibleWebRequest -Module $module
    #>
    [CmdletBinding()]
    [OutputType([System.Net.WebRequest])]
    Param (
        [Alias("url")]
        [System.Uri]
        $Uri,

        [System.String]
        $Method,

        [Alias("follow_redirects")]
        [ValidateSet("all", "none", "safe")]
        [System.String]
        $FollowRedirects = "safe",

        [System.Collections.IDictionary]
        $Headers,

        [Alias("http_agent")]
        [System.String]
        $HttpAgent = "ansible-httpget",

        [Alias("maximum_redirection")]
        [System.Int32]
        $MaximumRedirection = 50,

        [System.Int32]
        $Timeout = 30,

        [Alias("validate_certs")]
        [System.Boolean]
        $ValidateCerts = $true,

        # Credential params
        [Alias("client_cert")]
        [System.String]
        $ClientCert,

        [Alias("client_cert_password")]
        [System.String]
        $ClientCertPassword,

        [Alias("force_basic_auth")]
        [Switch]
        $ForceBasicAuth,

        [Alias("url_username")]
        [System.String]
        $UrlUsername,

        [Alias("url_password")]
        [System.String]
        $UrlPassword,

        [Alias("use_default_credential")]
        [Switch]
        $UseDefaultCredential,

        # Proxy params
        [Alias("use_proxy")]
        [System.Boolean]
        $UseProxy = $true,

        [Alias("proxy_url")]
        [System.String]
        $ProxyUrl,

        [Alias("proxy_username")]
        [System.String]
        $ProxyUsername,

        [Alias("proxy_password")]
        [System.String]
        $ProxyPassword,

        [Alias("proxy_use_default_credential")]
        [Switch]
        $ProxyUseDefaultCredential,

        [ValidateScript({ $_.GetType().FullName -eq 'Ansible.Basic.AnsibleModule' })]
        [System.Object]
        $Module
    )

    # Set module options for parameters unless they were explicitly passed in.
    if ($Module) {
        foreach ($param in $PSCmdlet.MyInvocation.MyCommand.Parameters.GetEnumerator()) {
            if ($PSBoundParameters.ContainsKey($param.Key)) {
                # Was set explicitly we want to use that value
                continue
            }

            foreach ($alias in @($Param.Key) + $param.Value.Aliases) {
                if ($Module.Params.ContainsKey($alias)) {
                    $var_value = $Module.Params.$alias -as $param.Value.ParameterType
                    Set-Variable -Name $param.Key -Value $var_value
                    break
                }
            }
        }
    }

    # Disable certificate validation if requested
    # FUTURE: set this on ServerCertificateValidationCallback of the HttpWebRequest once .NET 4.5 is the minimum
    if (-not $ValidateCerts) {
        [System.Net.ServicePointManager]::ServerCertificateValidationCallback = { $true }
    }

    # Enable TLS1.1/TLS1.2 if they're available but disabled (eg. .NET 4.5)
    $security_protocols = [System.Net.ServicePointManager]::SecurityProtocol -bor [System.Net.SecurityProtocolType]::SystemDefault
    if ([System.Net.SecurityProtocolType].GetMember("Tls11").Count -gt 0) {
        $security_protocols = $security_protocols -bor [System.Net.SecurityProtocolType]::Tls11
    }
    if ([System.Net.SecurityProtocolType].GetMember("Tls12").Count -gt 0) {
        $security_protocols = $security_protocols -bor [System.Net.SecurityProtocolType]::Tls12
    }
    [System.Net.ServicePointManager]::SecurityProtocol = $security_protocols

    $web_request = [System.Net.WebRequest]::Create($Uri)
    if ($Method) {
        $web_request.Method = $Method
    }
    $web_request.Timeout = $Timeout * 1000

    if ($UseDefaultCredential -and $web_request -is [System.Net.HttpWebRequest]) {
        $web_request.UseDefaultCredentials = $true
    } elseif ($UrlUsername) {
        if ($ForceBasicAuth) {
            $auth_value = [System.Convert]::ToBase64String([System.Text.Encoding]::ASCII.GetBytes(("{0}:{1}" -f $UrlUsername, $UrlPassword)))
            $web_request.Headers.Add("Authorization", "Basic $auth_value")
        } else {
            $credential = New-Object -TypeName System.Net.NetworkCredential -ArgumentList $UrlUsername, $UrlPassword
            $web_request.Credentials = $credential
        }
    }

    if ($ClientCert) {
        # Expecting either a filepath or PSPath (Cert:\CurrentUser\My\<thumbprint>)
        $cert = Get-Item -LiteralPath $ClientCert -ErrorAction SilentlyContinue
        if ($null -eq $cert) {
            Write-Error -Message "Client certificate '$ClientCert' does not exist" -Category ObjectNotFound
            return
        }

        $crypto_ns = 'System.Security.Cryptography.X509Certificates'
        if ($cert.PSProvider.Name -ne 'Certificate') {
            try {
                $cert = New-Object -TypeName "$crypto_ns.X509Certificate2" -ArgumentList @(
                    $ClientCert, $ClientCertPassword
                )
            } catch [System.Security.Cryptography.CryptographicException] {
                Write-Error -Message "Failed to read client certificate at '$ClientCert'" -Exception $_.Exception -Category SecurityError
                return
            }
        }
        $web_request.ClientCertificates = New-Object -TypeName "$crypto_ns.X509Certificate2Collection" -ArgumentList @(
            $cert
        )
    }

    if (-not $UseProxy) {
        $proxy = $null
    } elseif ($ProxyUrl) {
        $proxy = New-Object -TypeName System.Net.WebProxy -ArgumentList $ProxyUrl, $true
    } else  {
        $proxy = $web_request.Proxy
    }

    # $web_request.Proxy may return $null for a FTP web request. We only set the credentials if we have an actual
    # proxy to work with, otherwise just ignore the credentials property.
    if ($null -ne $proxy) {
        if ($ProxyUseDefaultCredential) {
            # Weird hack, $web_request.Proxy returns an IWebProxy object which only gurantees the Credentials
            # property. We cannot set UseDefaultCredentials so we just set the Credentials to the
            # DefaultCredentials in the CredentialCache which does the same thing.
            $proxy.Credentials = [System.Net.CredentialCache]::DefaultCredentials
        } elseif ($ProxyUsername) {
            $proxy.Credentials = New-Object -TypeName System.Net.NetworkCredential -ArgumentList @(
                $ProxyUsername, $ProxyPassword
            )
        } else {
            $proxy.Credentials = $null
        }

        $web_request.Proxy = $proxy
    }

    # Some parameters only apply when dealing with a HttpWebRequest
    if ($web_request -is [System.Net.HttpWebRequest]) {
        if ($Headers) {
            foreach ($header in $Headers.GetEnumerator()) {
                switch ($header.Key) {
                    Accept { $web_request.Accept = $header.Value }
                    Connection { $web_request.Connection = $header.Value }
                    Content-Length { $web_request.ContentLength = $header.Value }
                    Content-Type { $web_request.ContentType = $header.Value }
                    Expect { $web_request.Expect = $header.Value }
                    Date { $web_request.Date = $header.Value }
                    Host { $web_request.Host = $header.Value }
                    If-Modified-Since { $web_request.IfModifiedSince = $header.Value }
                    Range { $web_request.AddRange($header.Value) }
                    Referer { $web_request.Referer = $header.Value }
                    Transfer-Encoding {
                        $web_request.SendChunked = $true
                        $web_request.TransferEncoding = $header.Value
                    }
                    User-Agent { continue }
                    default { $web_request.Headers.Add($header.Key, $header.Value) }
                }
            }
        }

        # For backwards compatibility we need to support setting the User-Agent if the header was set in the task.
        # We just need to make sure that if an explicit http_agent module was set then that takes priority.
        if ($Headers -and $Headers.ContainsKey("User-Agent")) {
            if ($HttpAgent -eq $ansible_web_request_options.http_agent.default) {
                $HttpAgent = $Headers['User-Agent']
            } elseif ($null -ne $Module) {
                $Module.Warn("The 'User-Agent' header and the 'http_agent' was set, using the 'http_agent' for web request")
            }
        }
        $web_request.UserAgent = $HttpAgent

        switch ($FollowRedirects) {
            none { $web_request.AllowAutoRedirect = $false }
            safe {
                if ($web_request.Method -in @("GET", "HEAD")) {
                    $web_request.AllowAutoRedirect = $false
                } else {
                    $web_request.AllowAutoRedirect = $true
                }
            }
            all { $web_request.AllowAutoRedirect = $true }
        }

        if ($MaximumRedirection -eq 0) {
            $web_request.AllowAutoRedirect = $false
        } else {
            $web_request.MaximumAutomaticRedirections = $MaximumRedirection
        }
    }

    return $web_request
}

Function Invoke-WithWebRequest {
    <#
    .SYNOPSIS
    Invokes a ScriptBlock with the WebRequest.

    .DESCRIPTION
    Invokes the ScriptBlock and handle extra information like accessing the response stream, closing those streams
    safely as well as setting common module return values.

    .PARAMETER Module
    The Ansible.Basic module to set the return values for. This will set the following return values;
        elapsed - The total time, in seconds, that it took to send the web request and process the response
        msg - The human readable description of the response status code
        status_code - An int that is the response status code

    .PARAMETER Request
    The System.Net.WebRequest to call. This can either be manually crafted or created with Get-AnsibleWebRequest.

    .PARAMETER Script
    The ScriptBlock to invoke during the web request. This ScriptBlock should take in the params
        Param ([System.Net.WebResponse]$Response, [System.IO.Stream]$Stream)

    This scriptblock should manage the response based on what it need to do.

    .PARAMETER Body
    An optional Stream to send to the target during the request.

    .PARAMETER IgnoreBadResponse
    By default a WebException will be raised for a non 2xx status code and the Script will not be invoked. This
    parameter can be set to process all responses regardless of the status code.

    .EXAMPLE Basic module that downloads a file
    $spec = @{
        options = @{
            path = @{ type = "path"; required = $true }
        }
    }
    $spec.options += $ansible_web_request_options
    $module = Ansible.Basic.AnsibleModule]::Create($args, $spec)

    $web_request = Get-AnsibleWebRequest -Module $module

    Invoke-WithWebRequest -Module $module -Request $web_request -Script {
        Param ([System.Net.WebResponse]$Response, [System.IO.Stream]$Stream)

        $fs = [System.IO.File]::Create($module.Params.path)
        try {
            $Stream.CopyTo($fs)
            $fs.Flush()
        } finally {
            $fs.Dispose()
        }
    }
    #>
    [CmdletBinding()]
    param (
        [Parameter(Mandatory=$true)]
        [System.Object]
        [ValidateScript({ $_.GetType().FullName -eq 'Ansible.Basic.AnsibleModule' })]
        $Module,

        [Parameter(Mandatory=$true)]
        [System.Net.WebRequest]
        $Request,

        [Parameter(Mandatory=$true)]
        [ScriptBlock]
        $Script,

        [AllowNull()]
        [System.IO.Stream]
        $Body,

        [Switch]
        $IgnoreBadResponse
    )

    $start = Get-Date
    if ($null -ne $Body) {
        $request_st = $Request.GetRequestStream()
        try {
            $Body.CopyTo($request_st)
            $request_st.Flush()
        } finally {
            $request_st.Close()
        }
    }

    try {
        try {
            $web_response = $Request.GetResponse()
        } catch [System.Net.WebException] {
            # A WebResponse with a status code not in the 200 range will raise a WebException. We check if the
            # exception raised contains the actual response and continue on if IgnoreBadResponse is set. We also
            # make sure we set the status_code return value on the Module object if possible

            if ($_.Exception.PSObject.Properties.Name -match "Response") {
                $web_response = $_.Exception.Response

                if (-not $IgnoreBadResponse -or $null -eq $web_response) {
                    $Module.Result.msg = $_.Exception.StatusDescription
                    $Module.Result.status_code = $_.Exception.Response.StatusCode
                    throw $_
                }
            } else {
                throw $_
            }
        }

        if ($Request.RequestUri.IsFile) {
            # A FileWebResponse won't have these properties set
            $Module.Result.msg = "OK"
            $Module.Result.status_code = 200
        } else {
            $Module.Result.msg = $web_response.StatusDescription
            $Module.Result.status_code = $web_response.StatusCode
        }

        $response_stream = $web_response.GetResponseStream()
        try {
            # Invoke the ScriptBlock and pass in WebResponse and ResponseStream
            &$Script -Response $web_response -Stream $response_stream
        } finally {
            $response_stream.Dispose()
        }
    } finally {
        if ($web_response) {
            $web_response.Close()
        }
        $Module.Result.elapsed = ((Get-date) - $start).TotalSeconds
    }
}

$ansible_web_request_options = @{
    url = @{ type="str"; required=$true }
    method = @{ type="str" }
    follow_redirects = @{ type="str"; choices=@("all","none","safe"); default="safe" }
    headers = @{ type="dict" }
    http_agent = @{ type="str"; default="ansible-httpget" }
    maximum_redirection = @{ type="int"; default=50 }
    timeout = @{ type="int"; default=30 }  # Was defaulted to 10 in win_get_url but 30 in win_uri so we use 30
    validate_certs = @{ type="bool"; default=$true }

    # Credential options
    client_cert = @{ type="str" }
    client_cert_password = @{ type="str"; no_log=$true }
    force_basic_auth = @{ type="bool"; default=$false }
    url_username = @{ type="str"; aliases=@("user", "username") }  # user was used in win_uri
    url_password = @{ type="str"; aliases=@("password"); no_log=$true }
    use_default_credential = @{ type="bool"; default=$false }

    # Proxy options
    use_proxy = @{ type="bool"; default=$true }
    proxy_url = @{ type="str" }
    proxy_username = @{ type="str" }
    proxy_password = @{ type="str"; no_log=$true }
    proxy_use_default_credential = @{ type="bool"; default=$false }
}

$export_members = @{
    Function = "Get-AnsibleWebRequest", "Invoke-WithWebRequest"
    Variable = "ansible_web_request_options"
}
Export-ModuleMember @export_members


ScriptBlock ID: 58a7105b-4940-431f-aefc-b3c0f91a29f0
Path:
